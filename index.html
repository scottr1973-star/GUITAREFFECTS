<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Blues Harp Tone — Fully Wired</title>

<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: { sans:['Inter','system-ui','sans-serif'], display:['Orbitron','Inter','system-ui','sans-serif'] },
      colors:{ chrome:{ring:'#20324a'}, accent:{DEFAULT:'#60a5fa', deep:'#3b82f6'} },
      boxShadow:{ panel:'0 14px 32px rgba(0,0,0,0.45)' }
    }
  }
}
</script>

<style>
:root{ --slider-h:28px; --slider-track:9px; --thumb:20px; }
.hslider{-webkit-appearance:none;appearance:none;width:100%;height:var(--slider-h);background:transparent;display:block;cursor:pointer;touch-action:pan-y;}
.hslider:focus{outline:none;}
.hslider::-webkit-slider-runnable-track{height:var(--slider-track);border-radius:9999px;background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(0,0,0,.22)),linear-gradient(90deg,#2a3a56,#13233a);box-shadow:inset 0 1px 0 rgba(255,255,255,.10), inset 0 -1px 0 rgba(0,0,0,.45);}
.hslider::-moz-range-track{height:var(--slider-track);border-radius:9999px;background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(0,0,0,.22)),linear-gradient(90deg,#2a3a56,#13233a);box-shadow:inset 0 1px 0 rgba(255,255,255,.10), inset 0 -1px 0 rgba(0,0,0,.45);}
.hslider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:var(--thumb);height:var(--thumb);margin-top:calc((var(--slider-track)-var(--thumb))/2);border-radius:10px;background:radial-gradient(120% 120% at 30% 20%,#fff 0%,#eef6ff 55%,#dbeafe 80%,#bfdbfe 100%);border:1px solid #60a5fa;box-shadow:0 3px 10px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.8), inset 0 -1px 0 rgba(0,0,0,.35);}
.hslider::-moz-range-thumb{width:var(--thumb);height:var(--thumb);border-radius:10px;background:radial-gradient(120% 120% at 30% 20%,#fff 0%,#eef6ff 55%,#dbeafe 80%,#bfdbfe 100%);border:1px solid #60a5fa;box-shadow:0 3px 10px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.8), inset 0 -1px 0 rgba(0,0,0,.35);}
.toggle-pill{position:relative;display:inline-flex;height:28px;width:56px;align-items:center;border-radius:9999px;background:rgba(2,6,23,.85);box-shadow:inset 0 0 0 1px rgba(100,116,139,.6);}
.toggle-dot{position:absolute;left:4px;top:4px;height:20px;width:20px;border-radius:9999px;background:#f1f5f9;box-shadow:inset 0 1px 0 rgba(255,255,255,.75), inset 0 -1px 0 rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.35);transition:transform .2s;}
.toggle-on{background:#3b82f6;box-shadow:inset 0 0 0 1px rgba(59,130,246,.7);}
.dot-on{transform:translateX(28px);}
#vu-wrap{height:clamp(18px,4.5vw,26px);}
.vu-mini{height:14px;}
canvas{display:block;width:100%;height:100%;}
.slotbtn{padding:.25rem .5rem;border-radius:.375rem;font-size:11px;background:rgba(2,6,23,.6);border:1px solid rgba(71,85,105,.8);}
#message-box{position:fixed;top:-100px;left:50%;transform:translateX(-50%);background:#ef4444;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 12px 30px rgba(0,0,0,.3);font-weight:700;z-index:1000;transition:top .45s;}
</style>
</head>

<body class="min-h-screen bg-gradient-to-br from-[#0b1a2a] via-[#0d2340] to-[#0a1730] text-slate-100 antialiased">
<div id="message-box">Mic permission needed. Click Start and allow access.</div>

<main class="mx-auto p-3 sm:p-4">
<section class="mx-auto w-full max-w-[360px] sm:max-w-[560px] md:max-w-[880px]
                 rounded-3xl border border-chrome-ring shadow-panel relative overflow-hidden
                 bg-[radial-gradient(140%_120%_at_0%_0%,#1f2f4d_0%,rgba(24,42,76,0.95)_45%,#152a49_100%)]">
  <div class="pointer-events-none absolute inset-0 rounded-3xl" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.10), inset 0 -2px 0 rgba(0,0,0,.45)"></div>

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 border-b border-slate-700/60 px-4 pt-4 pb-3">
    <div class="flex-1 min-w-0">
      <h1 class="font-display text-lg sm:text-xl tracking-wide drop-shadow-[0_0_12px_rgba(96,165,250,0.45)]">BLUES HARP TONE</h1>
      <p class="text-[12px] text-slate-300">Click <strong>Start Audio</strong> → allow mic → set Monitor to <strong>Processed</strong> to hear the chain.</p>
    </div>

    <div class="flex items-center gap-3 flex-wrap">
      <div class="flex items-center gap-2 text-[11px]">
        <label class="text-slate-200/90">Monitor</label>
        <select id="monitor-mode" class="px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md">
          <option value="direct" selected>Direct (safe)</option>
          <option value="processed">Processed</option>
        </select>
      </div>
      <div class="flex items-center gap-2 text-[11px]">
        <span>OS DSP</span>
        <button id="os-dsp" class="toggle-pill toggle-on"><span class="toggle-dot dot-on"></span></button>
      </div>
      <button id="btn-start" class="px-3 py-2 rounded-lg text-[12px] font-semibold bg-gradient-to-b from-accent to-accent-deep text-slate-900 ring-1 ring-white/30 hover:brightness-95 active:brightness-90">Start Audio</button>
      <div class="flex items-center gap-2 text-[11px]">
        <span id="status-led" class="inline-block h-3 w-3 rounded-full bg-slate-600 ring-2 ring-slate-900"></span>
        <span id="status-text" class="text-slate-200/90">Off</span>
      </div>
    </div>
  </div>

  <!-- Devices + meters -->
  <div class="px-4 pt-2 space-y-2">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div class="flex items-center gap-2 flex-1">
        <label class="text-[12px]">Input:</label>
        <select id="device-select" class="min-w-[200px] max-w-full flex-1 px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md"></select>
        <button id="device-refresh" class="px-2 py-1 text-[11px] rounded-md bg-slate-900/60 ring-1 ring-slate-600 hover:bg-slate-900">Refresh</button>
      </div>
      <div class="text-[11px] text-slate-200/90 flex items-center gap-3">
        <span id="sr-readout">SR: —</span><span>•</span><span id="lat-readout">Latency: —</span>
      </div>
    </div>

    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <button id="vu-mode" class="px-2 py-0.5 rounded-md text-[11px] ring-1 ring-slate-600 bg-slate-900/60 hover:bg-slate-900">RMS</button>
        <div class="flex items-center gap-1 text-[11px]"><span class="text-slate-200/80">CLIP</span><div id="clip-led" class="h-3 w-3 rounded-full bg-slate-600 ring-2 ring-slate-900"></div></div>
      </div>
      <div class="text-[11px] text-slate-200/90">Limiter GR: <span id="lim-gr">0.0</span> dB</div>
    </div>
    <div id="vu-wrap" class="relative rounded-xl ring-1 ring-slate-700 bg-[#0a1930]/80 overflow-hidden">
      <canvas id="vu-canvas"></canvas>
      <div class="pointer-events-none absolute inset-0 rounded-xl" style="background:linear-gradient(180deg,rgba(255,255,255,.10),transparent 50%,rgba(255,255,255,.06));"></div>
    </div>

    <div class="grid grid-cols-2 gap-2">
      <div class="rounded-md ring-1 ring-slate-700 bg-[#0a1930]/70 px-2 py-1">
        <div class="flex items-center justify-between text-[11px] mb-1"><span>Pre</span><span class="text-slate-400">input</span></div>
        <div class="vu-mini rounded-sm overflow-hidden"><canvas id="in-canvas"></canvas></div>
      </div>
      <div class="rounded-md ring-1 ring-slate-700 bg-[#0a1930]/70 px-2 py-1">
        <div class="flex items-center justify-between text-[11px] mb-1"><span>Post</span><span class="text-slate-400">output</span></div>
        <div class="vu-mini rounded-sm overflow-hidden"><canvas id="out-canvas"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Controls (same as previous) -->
  <div class="px-4 pb-5 pt-3 space-y-4">

    <!-- Input / Gate -->
    <div class="rounded-2xl border border-slate-700 bg-gradient-to-b from-[#19335b] to-[#152a49] p-3" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);">
      <div class="grid grid-cols-12 items-center gap-2">
        <div class="col-span-12 sm:col-span-6">
          <div class="flex items-center justify-between mb-1">
            <div class="text-[12px] uppercase tracking-wider text-slate-100">Input Trim</div>
            <div class="text-xs text-slate-100/90"><span id="trim-val">0</span> dB</div>
          </div>
          <input id="input-trim" class="hslider" type="range" min="-18" max="24" step="0.5" value="0"/>
          <button id="btn-calibrate" class="mt-2 px-2 py-1 text-[11px] rounded-md bg-accent/20 ring-1 ring-accent/40 hover:bg-accent/30">Auto-Cal to −18 dBFS</button>
        </div>
        <div class="col-span-12 sm:col-span-6 mt-3 sm:mt-0">
          <div class="flex items-center justify-between">
            <div class="text-[12px] uppercase tracking-wider text-slate-100">Noise Gate</div>
            <div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="gate-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div>
          </div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Threshold</div><div class="col-span-6"><input id="gate-threshold" class="hslider" type="range" min="-80" max="-20" step="1" value="-60"/></div><div class="col-span-2 text-right text-[11px]"><span id="gate-thresh-val">-60</span> dB</div>
            <div class="col-span-4 text-[11px] mt-2">Release</div><div class="col-span-6 mt-2"><input id="gate-release" class="hslider" type="range" min="0.02" max="0.4" step="0.01" value="0.18"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="gate-rel-val">0.18</span>s</div>
          </div>
        </div>
      </div>
    </div>

    <!-- HPF / Drive -->
    <div class="rounded-2xl border border-slate-700 bg-gradient-to-b from-[#19335b] to-[#152a49] p-3" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);">
      <div class="grid grid-cols-12 items-center gap-2">
        <div class="col-span-12 sm:col-span-6">
          <div class="flex items-center justify-between">
            <div class="text-[12px] uppercase tracking-wider text-slate-100">HPF</div>
            <div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="hpf-enable" class="toggle-pill toggle-on"><span class="toggle-dot dot-on"></span></button></div>
          </div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Freq</div><div class="col-span-6"><input id="hpf-freq" class="hslider" type="range" min="20" max="200" step="1" value="100"/></div><div class="col-span-2 text-right text-[11px]"><span id="hpf-val">100</span> Hz</div>
          </div>
        </div>
        <div class="col-span-12 sm:col-span-6 mt-3 sm:mt-0">
          <div class="flex items-center justify-between">
            <div class="text-[12px] uppercase tracking-wider text-slate-100">Drive</div>
            <div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="drive-enable" class="toggle-pill toggle-on"><span class="toggle-dot dot-on"></span></button></div>
          </div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Gain</div><div class="col-span-6"><input id="amp-gain" class="hslider" type="range" min="0" max="100" step="1" value="25"/></div><div class="col-span-2 text-right text-[11px]"><span id="gain-value">25</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hum killer -->
    <div class="rounded-2xl border border-slate-700 bg-gradient-to-b from-[#19335b] to-[#152a49] p-3" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);">
      <div class="grid grid-cols-12 items-center gap-2">
        <div class="col-span-12 sm:col-span-6">
          <div class="flex items-center justify-between">
            <div class="text-[12px] uppercase tracking-wider text-slate-100">Hum Killer</div>
            <div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="hum-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div>
          </div>
          <div class="mt-2 flex items-center gap-2 text-[12px]">
            <label class="text-slate-300">Mains:</label>
            <select id="hum-mains" class="px-2 py-1 bg-slate-900/70 ring-1 ring-slate-600 rounded-md">
              <option value="60" selected>60 Hz</option><option value="50">50 Hz</option>
            </select>
            <label class="ml-3 text-slate-300">2nd Harmonic</label>
            <button id="hum-2nd" class="toggle-pill"><span class="toggle-dot"></span></button>
          </div>
        </div>
        <div class="col-span-12 sm:col-span-6 text-[12px] text-slate-300/90">
          Notch filters placed pre-drive. Use when you can’t fix ground loops.
        </div>
      </div>
    </div>

    <!-- 3-Band EQ -->
    <div class="rounded-2xl border border-slate-700 bg-gradient-to-b from-[#19335b] to-[#152a49] p-3" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);">
      <div class="mb-1 flex items-center justify-between">
        <div class="text-[12px] uppercase tracking-wider text-slate-100">3-Band EQ</div>
        <div class="text-[11px] text-slate-200/80">Low 120 Hz • Mid 1.2 kHz • High 6 kHz</div>
      </div>
      <div class="grid grid-cols-12 items-center gap-2">
        <div class="col-span-4 text-[11px]">Low</div><div class="col-span-6"><input id="eq-low" class="hslider" type="range" min="-12" max="12" step="0.5" value="0"/></div><div class="col-span-2 text-right text-[11px]"><span id="eq-low-val">0</span> dB</div>
        <div class="col-span-4 text-[11px] mt-2">Mid</div><div class="col-span-6 mt-2"><input id="eq-mid" class="hslider" type="range" min="-12" max="12" step="0.5" value="0"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="eq-mid-val">0</span> dB</div>
        <div class="col-span-4 text-[11px] mt-2">High</div><div class="col-span-6 mt-2"><input id="eq-high" class="hslider" type="range" min="-12" max="12" step="0.5" value="0"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="eq-high-val">0</span> dB</div>
      </div>
    </div>

    <!-- Compressor / Reverb / Slapback -->
    <div class="rounded-2xl border border-slate-700 bg-gradient-to-b from-[#19335b] to-[#152a49] p-3" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);">
      <div class="grid grid-cols-12 items-center gap-2">
        <div class="col-span-12 md:col-span-7">
          <div class="flex items-center justify-between">
            <div class="text-[12px] uppercase tracking-wider text-slate-100">Compressor</div>
            <div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="comp-enable" class="toggle-pill toggle-on"><span class="toggle-dot dot-on"></span></button></div>
          </div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-3 text-[11px]">Thresh</div><div class="col-span-6"><input id="comp-thresh" class="hslider" type="range" min="-50" max="0" step="1" value="-22"/></div><div class="col-span-3 text-right text-[11px]"><span id="comp-thresh-val">-22</span> dB</div>
            <div class="col-span-3 text-[11px] mt-2">Ratio</div><div class="col-span-6 mt-2"><input id="comp-ratio" class="hslider" type="range" min="1" max="20" step="0.5" value="3.0"/></div><div class="col-span-3 text-right text-[11px] mt-2"><span id="comp-ratio-val">3.0</span>:1</div>
            <div class="col-span-3 text-[11px] mt-2">Attack</div><div class="col-span-6 mt-2"><input id="comp-attack" class="hslider" type="range" min="0.001" max="0.1" step="0.001" value="0.012"/></div><div class="col-span-3 text-right text-[11px] mt-2"><span id="comp-attack-val">0.012</span>s</div>
            <div class="col-span-3 text-[11px] mt-2">Release</div><div class="col-span-6 mt-2"><input id="comp-release" class="hslider" type="range" min="0.02" max="0.5" step="0.01" value="0.18"/></div><div class="col-span-3 text-right text-[11px] mt-2"><span id="comp-release-val">0.18</span>s</div>
            <div class="col-span-3 text-[11px] mt-2">Makeup</div><div class="col-span-6 mt-2"><input id="comp-makeup" class="hslider" type="range" min="0" max="12" step="0.5" value="2"/></div><div class="col-span-3 text-right text-[11px] mt-2"><span id="comp-makeup-val">2</span> dB</div>
          </div>
        </div>

        <div class="col-span-12 md:col-span-5 mt-3 md:mt-0">
          <div class="flex items-center justify-between">
            <div class="text-[12px] uppercase tracking-wider text-slate-100">Reverb</div>
            <div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="reverb-enable" class="toggle-pill toggle-on"><span class="toggle-dot dot-on"></span></button></div>
          </div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Mix</div><div class="col-span-6"><input id="reverb-mix" class="hslider" type="range" min="0" max="1" step="0.01" value="0.15"/></div><div class="col-span-2 text-right text-[11px]"><span id="reverb-value">0.15</span></div>
          </div>
        </div>

        <div class="col-span-12 md:col-span-5">
          <div class="mt-3 md:mt-2 flex items-center justify-between">
            <div class="text-[12px] uppercase tracking-wider text-slate-100">Slapback</div>
            <div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="delay-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div>
          </div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Mix</div><div class="col-span-6"><input id="delay-mix" class="hslider" type="range" min="0" max="0.8" step="0.01" value="0.2"/></div><div class="col-span-2 text-right text-[11px]"><span id="delay-val">0.20</span></div>
          </div>
          <p class="mt-1 text-[11px] text-slate-300/80">110 ms single repeat, parallel post-comp, pre-reverb.</p>
        </div>
      </div>
    </div>

    <!-- LPF / Output / Presets -->
    <div class="rounded-2xl border border-slate-700 bg-gradient-to-b from-[#19335b] to-[#152a49] p-3" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);">
      <div class="grid grid-cols-12 items-center gap-2">
        <div class="col-span-12 sm:col-span-6">
          <div class="flex items-center justify-between">
            <div class="text-[12px] uppercase tracking-wider text-slate-100">LPF</div>
            <div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="lpf-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div>
          </div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Freq</div><div class="col-span-6"><input id="lpf-freq" class="hslider" type="range" min="4000" max="12000" step="100" value="9500"/></div><div class="col-span-2 text-right text-[11px]"><span id="lpf-val">9500</span> Hz</div>
          </div>
        </div>

        <div class="col-span-12 sm:col-span-6 mt-2 sm:mt-0">
          <div class="grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px] uppercase tracking-wider text-slate-100">Output Level</div>
            <div class="col-span-6"><input id="output-level" class="hslider" type="range" min="0" max="1" step="0.01" value="1"/></div>
            <div class="col-span-2 text-right text-[11px]"><span id="out-val">1.00</span></div>

            <div class="col-span-12 mt-2">
              <div class="flex items-center gap-2">
                <select id="preset-select" class="w-full px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md">
                  <option value="">— Built-in Presets —</option>
                  <option>Classic Chicago</option>
                  <option>Crunch Amp</option>
                  <option>Fat Low End</option>
                  <option>Bright Cut</option>
                  <option>Little Walter Cup</option>
                  <option>Country Clean</option>
                  <option>Dark Mellow</option>
                  <option>Lo-Fi Amp</option>
                  <option>Big Room</option>
                  <option>Cut Through Band</option>
                  <option>Modern Blues Rock</option>
                  <option>Vintage Jazz Tone</option>
                  <option>Country Bright</option>
                </select>
                <button id="preset-apply" class="px-2 py-1 text-[11px] rounded-md bg-slate-900/60 ring-1 ring-slate-600 hover:bg-slate-900">Load</button>
              </div>
            </div>
          </div>
        </div>

        <!-- User slots -->
        <div class="col-span-12 mt-3">
          <div class="flex flex-col sm:flex-row gap-2">
            <select id="user-slot-select" class="flex-1 px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md"></select>
            <input id="slot-name-input" class="flex-1 px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md" placeholder="Preset name (optional)"/>
            <div class="flex gap-2">
              <button id="slot-load"  class="slotbtn">Load</button>
              <button id="slot-save"  class="px-2 py-1 text-[11px] rounded-md bg-accent/20 ring-1 ring-accent/40 hover:bg-accent/30">Save</button>
              <button id="slot-rename" class="slotbtn">Rename</button>
              <button id="slot-export" class="slotbtn">Export</button>
              <button id="slot-import" class="slotbtn">Import</button>
              <input id="import-file" type="file" accept="application/json" class="hidden"/>
            </div>
          </div>
          <p class="mt-1 text-[11px] text-slate-300/80">10 user slots stored locally.</p>
          <div class="mt-2 grid grid-cols-2 sm:grid-cols-5 gap-2" id="slot-grid"></div>
        </div>
      </div>
    </div>
  </div>
</section>
</main>

<script>
/* ========= Utils ========= */
const $=id=>document.getElementById(id);
const dBToLinear=d=>Math.pow(10,d/20);
const linearToDb=x=>(x>0?20*Math.log10(x):-Infinity);
function toast(msg){ const b=$('message-box'); b.textContent=msg; b.style.top='20px'; setTimeout(()=>b.style.top='-100px',3000); }
function setToggle(btn,on){ btn.classList.toggle('toggle-on',on); const dot=btn.querySelector('.toggle-dot'); if(dot) dot.classList.toggle('dot-on',on); }
function isOn(btn){ return btn.classList.contains('toggle-on'); }
function clamp(n,min,max){ return Math.min(max,Math.max(min,n)); }

/* ========= UI Refs ========= */
const btnStart=$('btn-start'), statusLed=$('status-led'), statusText=$('status-text');
const devSel=$('device-select'), devRef=$('device-refresh');
const srOut=$('sr-readout'), latOut=$('lat-readout');
const monitorSel=$('monitor-mode'), osDSPBtn=$('os-dsp');

const trimSl=$('input-trim'), trimVal=$('trim-val'), btnCal=$('btn-calibrate');
const gateBtn=$('gate-enable'), gateTh=$('gate-threshold'), gateRl=$('gate-release'), gateThVal=$('gate-thresh-val'), gateRlVal=$('gate-rel-val');
const hpfBtn=$('hpf-enable'), hpfFreq=$('hpf-freq'), hpfVal=$('hpf-val');

const humBtn=$('hum-enable'), humMains=$('hum-mains'), hum2nd=$('hum-2nd');

const drvBtn=$('drive-enable'), ampGain=$('amp-gain'), gainValue=$('gain-value');

const eqLow=$('eq-low'), eqLowVal=$('eq-low-val');
const eqMid=$('eq-mid'), eqMidVal=$('eq-mid-val');
const eqHigh=$('eq-high'), eqHighVal=$('eq-high-val');

const compBtn=$('comp-enable'), cTh=$('comp-thresh'), cRa=$('comp-ratio'), cAt=$('comp-attack'), cRe=$('comp-release'), cMk=$('comp-makeup');
const cThVal=$('comp-thresh-val'), cRaVal=$('comp-ratio-val'), cAtVal=$('comp-attack-val'), cReVal=$('comp-release-val'), cMkVal=$('comp-makeup-val');

const dlyBtn=$('delay-enable'), dlyMix=$('delay-mix'), dlyVal=$('delay-val');
const rvbBtn=$('reverb-enable'), rvbMix=$('reverb-mix'), rvbVal=$('reverb-value');

const lpfBtn=$('lpf-enable'), lpfFreq=$('lpf-freq'), lpfOut=$('lpf-val');

const outSl=$('output-level'), outVal=$('out-val');

const presetSel=$('preset-select'), presetApply=$('preset-apply');
const slotSel=$('user-slot-select'), slotName=$('slot-name-input');
const slotLoad=$('slot-load'), slotSave=$('slot-save'), slotRename=$('slot-rename'), slotExport=$('slot-export'), slotImport=$('slot-import'), importFile=$('import-file');
const slotGrid=$('slot-grid');

const vuCanvas=$('vu-canvas'), inCanvas=$('in-canvas'), outCanvas=$('out-canvas'), vuModeBtn=$('vu-mode'), clipLED=$('clip-led'), limGR=$('lim-gr');

/* ========= Audio State ========= */
let audioContext, micSource, running=false, currentDeviceId=null;

/* Nodes */
let inputTrim, preAnalyser, hpf, hum1, hum2, gateGain;
let driveWS, driveWet, driveDry;
let eqLowNode, eqMidNode, eqHighNode;
let comp, compMakeup;
let slapDelay, dlyWet, dlyDry;
let rvConv, rvWet, rvDry;
let lpfNode, limiter, procGate, masterOut, postAnalyser, directMon;

/* ========= Power ========= */
btnStart.addEventListener('click', async ()=>{ if(!running) await startAudio(); else stopAudio(); });

async function startAudio(){
  try{
    if (!navigator.mediaDevices?.getUserMedia){ toast('getUserMedia not supported.'); return; }
    if (location.protocol !== 'https:' && location.hostname !== 'localhost'){ toast('Mic requires HTTPS or localhost.'); }

    if (!audioContext) audioContext = new (window.AudioContext||window.webkitAudioContext)();
    if (audioContext.state==='suspended'){ try{ await audioContext.resume(); }catch{} }

    srOut.textContent=`SR: ${audioContext.sampleRate} Hz`;
    const lat=(audioContext.baseLatency||0)+(audioContext.outputLatency||0);
    latOut.textContent=`Latency: ${Math.round(lat*1000)} ms`;

    const useDSP=isOn(osDSPBtn);
    const constraints={audio:{echoCancellation:useDSP,noiseSuppression:useDSP,autoGainControl:useDSP,channelCount:{ideal:1},...(currentDeviceId?{deviceId:{exact:currentDeviceId}}:{})}};
    const stream=await navigator.mediaDevices.getUserMedia(constraints);
    micSource=audioContext.createMediaStreamSource(stream);

    await populateDevices();
    buildGraph();
    wireControls();
    setMonitor(monitorSel.value||'direct');

    running=true;
    btnStart.textContent='Stop Audio'; statusText.textContent='On'; statusLed.style.backgroundColor='#22c55e';

    sizeAllCanvases();
    startMeters();
    startGateLoop();
    initSlotsUI();
  }catch(e){
    console.error(e);
    toast('Mic permission blocked/unavailable');
    stopAudio();
  }
}

function stopAudio(){
  stopMeters();
  try{ if(micSource?.mediaStream){ micSource.mediaStream.getTracks().forEach(t=>t.stop()); } }catch{}
  try{ if(audioContext && audioContext.state!=='closed'){ audioContext.close().then(()=>{ audioContext=null; }); } }catch{}
  running=false; btnStart.textContent='Start Audio'; statusText.textContent='Off'; statusLed.style.backgroundColor='#64748b';
  clearCanvases();
}

/* ========= Devices ========= */
async function populateDevices(){
  try{
    const devs=await navigator.mediaDevices.enumerateDevices();
    const inputs=devs.filter(d=>d.kind==='audioinput');
    devSel.innerHTML='';
    inputs.forEach((d,i)=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||`Input ${i+1}`; devSel.appendChild(o); });
    const saved=localStorage.getItem('harpPreferredDevice');
    const target=currentDeviceId||saved;
    if(target){ const f=[...devSel.options].find(o=>o.value===target); if(f) devSel.value=target; }
  }catch(e){ console.warn('enumerateDevices failed',e); }
}
devRef.addEventListener('click', populateDevices);
devSel.addEventListener('change', ()=>{ currentDeviceId=devSel.value||null; localStorage.setItem('harpPreferredDevice', currentDeviceId||''); if(running){ stopAudio(); startAudio(); }});
navigator.mediaDevices?.addEventListener?.('devicechange', populateDevices);

/* ========= Graph ========= */
function buildGraph(){
  const ctx=audioContext;

  // Pre
  inputTrim=ctx.createGain(); inputTrim.gain.value=dBToLinear(parseFloat(trimSl.value));
  preAnalyser=ctx.createAnalyser(); preAnalyser.fftSize=2048;

  // HPF
  hpf=ctx.createBiquadFilter(); hpf.type='highpass'; hpf.frequency.value=parseFloat(hpfFreq.value);

  // Hum killer
  hum1=ctx.createBiquadFilter(); hum1.type='allpass'; hum1.Q.value=25;
  hum2=ctx.createBiquadFilter(); hum2.type='allpass'; hum2.Q.value=20;

  // Gate control gain
  gateGain=ctx.createGain(); gateGain.gain.value=1;

  // Drive (waveshaper) with blend
  driveWS=ctx.createWaveShaper(); driveWS.curve=makeDist(parseInt(ampGain.value,10)); driveWS.oversample='4x';
  driveWet=ctx.createGain(); driveWet.gain.value=isOn(drvBtn)?1:0;
  driveDry=ctx.createGain(); driveDry.gain.value=isOn(drvBtn)?0:1;

  // 3-band EQ
  eqLowNode=ctx.createBiquadFilter(); eqLowNode.type='lowshelf'; eqLowNode.frequency.value=120; eqLowNode.gain.value=parseFloat(eqLow.value);
  eqMidNode=ctx.createBiquadFilter(); eqMidNode.type='peaking'; eqMidNode.frequency.value=1200; eqMidNode.Q.value=0.9; eqMidNode.gain.value=parseFloat(eqMid.value);
  eqHighNode=ctx.createBiquadFilter(); eqHighNode.type='highshelf'; eqHighNode.frequency.value=6000; eqHighNode.gain.value=parseFloat(eqHigh.value);

  // Compressor + makeup
  comp=ctx.createDynamicsCompressor();
  comp.threshold.value=parseFloat(cTh.value);
  comp.ratio.value=parseFloat(cRa.value);
  comp.attack.value=parseFloat(cAt.value);
  comp.release.value=parseFloat(cRe.value);
  compMakeup=ctx.createGain(); compMakeup.gain.value=dBToLinear(parseFloat(cMk.value));

  // Slapback (110ms parallel)
  slapDelay=ctx.createDelay(1.0); slapDelay.delayTime.value=0.11;
  dlyWet=ctx.createGain(); dlyWet.gain.value=isOn(dlyBtn)?parseFloat(dlyMix.value):0;
  dlyDry=ctx.createGain(); dlyDry.gain.value=1;

  // Reverb (parallel)
  rvConv=ctx.createConvolver(); rvConv.buffer=createIR(2.2,1.6);
  rvWet=ctx.createGain(); rvDry=ctx.createGain();
  setReverbMix(parseFloat(rvbMix.value), isOn(rvbBtn));

  // LPF
  lpfNode=ctx.createBiquadFilter(); lpfNode.type='lowpass'; lpfNode.frequency.value=isOn(lpfBtn)?parseFloat(lpfFreq.value):22050;

  // Limiter + monitor gate + output
  limiter=ctx.createDynamicsCompressor(); limiter.threshold.value=-1; limiter.knee.value=0; limiter.ratio.value=20; limiter.attack.value=0.002; limiter.release.value=0.08;
  procGate=ctx.createGain(); procGate.gain.value=0; // muted until "Processed" selected
  masterOut=ctx.createGain(); masterOut.gain.value=parseFloat(outSl.value);
  postAnalyser=ctx.createAnalyser(); postAnalyser.fftSize=2048;
  directMon=ctx.createGain(); directMon.gain.value=1;

  /* ----- Wiring ----- */
  micSource.connect(inputTrim);
  inputTrim.connect(preAnalyser);

  inputTrim.connect(hpf);
  hpf.connect(hum1); hum1.connect(hum2);
  hum2.connect(gateGain);

  gateGain.connect(driveWS);
  driveWS.connect(driveWet);
  gateGain.connect(driveDry);
  const driveSum=ctx.createGain(); driveWet.connect(driveSum); driveDry.connect(driveSum);

  driveSum.connect(eqLowNode); eqLowNode.connect(eqMidNode); eqMidNode.connect(eqHighNode); eqHighNode.connect(comp); comp.connect(compMakeup);

  compMakeup.connect(slapDelay); slapDelay.connect(dlyWet);
  compMakeup.connect(dlyDry);
  const dlySum=ctx.createGain(); dlyWet.connect(dlySum); dlyDry.connect(dlySum);

  compMakeup.connect(rvConv); rvConv.connect(rvWet);
  compMakeup.connect(rvDry);
  const rvSum=ctx.createGain(); rvWet.connect(rvSum); rvDry.connect(rvSum);

  const finalBus=ctx.createGain();
  dlySum.connect(finalBus); rvSum.connect(finalBus);
  finalBus.connect(lpfNode);
  lpfNode.connect(limiter);
  limiter.connect(procGate);
  procGate.connect(masterOut);
  masterOut.connect(postAnalyser);
  masterOut.connect(ctx.destination);

  micSource.connect(directMon);
  directMon.connect(ctx.destination);

  applyHum();
}

/* ========= Monitor ========= */
function setMonitor(mode){
  if(!audioContext) return;
  const t=audioContext.currentTime;
  if((mode||'direct')==='processed'){
    procGate.gain.setTargetAtTime(1,t,0.01);
    directMon.gain.setTargetAtTime(0,t,0.01);
  }else{
    procGate.gain.setTargetAtTime(0,t,0.01);
    directMon.gain.setTargetAtTime(1,t,0.01);
  }
}

/* ========= DSP helpers ========= */
function makeDist(amount){ const k=amount|0, n=44100, curve=new Float32Array(n), deg=Math.PI/180; for(let i=0;i<n;i++){ const x=(i*2/n)-1; curve[i]=(3+k)*x*20*deg/(Math.PI+k*Math.abs(x)); } return curve; }
function createIR(duration=2.2,decay=1.6){ if(!audioContext) return null; const sr=audioContext.sampleRate, L=Math.floor(sr*duration), buf=audioContext.createBuffer(2,L,sr); for(let ch=0;ch<2;ch++){ const d=buf.getChannelData(ch); for(let i=0;i<L;i++){ const t=i/L; const k=Math.pow(1-t,decay); d[i]=(Math.random()*2-1)*k; } } return buf; }
function setReverbMix(mix,on){ if(!rvWet||!rvDry) return; const wet=on?mix:0, dry=on?(1-mix):1; rvWet.gain.setValueAtTime(wet,audioContext.currentTime); rvDry.gain.setValueAtTime(dry,audioContext.currentTime); }

/* ========= UI Wiring ========= */
function wireControls(){
  monitorSel.addEventListener('change', ()=> setMonitor(monitorSel.value));

  osDSPBtn.addEventListener('click', ()=>{ setToggle(osDSPBtn,!isOn(osDSPBtn)); if(running){ stopAudio(); startAudio(); } });

  trimSl.addEventListener('input', ()=>{ trimVal.textContent=trimSl.value; if(inputTrim) inputTrim.gain.value=dBToLinear(parseFloat(trimSl.value)); });
  btnCal.addEventListener('click', ()=>{
    if(!running){ toast('Start Audio first'); return; }
    const td=new Uint8Array(preAnalyser.fftSize); let acc=0,n=0; const t0=performance.now();
    (function loop(){
      preAnalyser.getByteTimeDomainData(td); let sum=0; for(let i=0;i<td.length;i++){ const v=(td[i]-128)/128; sum+=v*v; }
      acc+=Math.sqrt(sum/td.length); n++;
      if(performance.now()-t0<1000) requestAnimationFrame(loop);
      else{
        const avg=acc/Math.max(1,n), target=-18, targetLin=Math.pow(10,target/20);
        let need=20*Math.log10(targetLin/Math.max(avg,1e-6))+parseFloat(trimSl.value);
        need=Math.min(24,Math.max(-18,need));
        trimSl.value=need.toFixed(1); trimVal.textContent=trimSl.value;
        if(inputTrim) inputTrim.gain.value=dBToLinear(parseFloat(trimSl.value));
      }
    })();
  });

  hpfBtn.addEventListener('click', ()=>{ setToggle(hpfBtn,!isOn(hpfBtn)); if(hpf) hpf.frequency.value = isOn(hpfBtn)?parseFloat(hpfFreq.value):20; });
  hpfFreq.addEventListener('input', ()=>{ hpfVal.textContent=hpfFreq.value; if(hpf) hpf.frequency.value=parseFloat(hpfFreq.value); });

  function applyDriveUI(){ gainValue.textContent=ampGain.value; if(driveWS) driveWS.curve=makeDist(parseInt(ampGain.value,10)); if(driveWet&&driveDry){ const on=isOn(drvBtn); driveWet.gain.value=on?1:0; driveDry.gain.value=on?0:1; } }
  drvBtn.addEventListener('click', ()=>{ setToggle(drvBtn,!isOn(drvBtn)); applyDriveUI(); });
  ampGain.addEventListener('input', applyDriveUI);

  function eqApply(){ eqLowVal.textContent=eqLow.value; eqMidVal.textContent=eqMid.value; eqHighVal.textContent=eqHigh.value;
    if(eqLowNode) eqLowNode.gain.value=parseFloat(eqLow.value);
    if(eqMidNode) eqMidNode.gain.value=parseFloat(eqMid.value);
    if(eqHighNode) eqHighNode.gain.value=parseFloat(eqHigh.value);
  }
  [eqLow,eqMid,eqHigh].forEach(el=>el.addEventListener('input', eqApply));

  function compApplyVals(){
    cThVal.textContent=cTh.value; cRaVal.textContent=parseFloat(cRa.value).toFixed(1);
    cAtVal.textContent=parseFloat(cAt.value).toFixed(3); cReVal.textContent=parseFloat(cRe.value).toFixed(2);
    cMkVal.textContent=cMk.value;
    if(comp){ comp.threshold.value=parseFloat(cTh.value); comp.ratio.value=parseFloat(cRa.value); comp.attack.value=parseFloat(cAt.value); comp.release.value=parseFloat(cRe.value); }
    if(compMakeup) compMakeup.gain.value=dBToLinear(parseFloat(cMk.value));
  }
  [cTh,cRa,cAt,cRe,cMk].forEach(el=>el.addEventListener('input', compApplyVals));
  compBtn.addEventListener('click', ()=>{ setToggle(compBtn,!isOn(compBtn)); const on=isOn(compBtn); if(comp){ comp.threshold.value= on?parseFloat(cTh.value):0; comp.ratio.value=on?parseFloat(cRa.value):1; comp.attack.value=on?parseFloat(cAt.value):0.001; comp.release.value=on?parseFloat(cRe.value):0.05; } if(compMakeup) compMakeup.gain.value=dBToLinear(on?parseFloat(cMk.value):0); });

  dlyBtn.addEventListener('click', ()=>{ setToggle(dlyBtn,!isOn(dlyBtn)); if(dlyWet) dlyWet.gain.value=isOn(dlyBtn)?parseFloat(dlyMix.value):0; });
  dlyMix.addEventListener('input', ()=>{ dlyVal.textContent=parseFloat(dlyMix.value).toFixed(2); if(dlyWet) dlyWet.gain.value=isOn(dlyBtn)?parseFloat(dlyMix.value):0; });

  rvbBtn.addEventListener('click', ()=>{ setToggle(rvbBtn,!isOn(rvbBtn)); setReverbMix(parseFloat(rvbMix.value), isOn(rvbBtn)); });
  rvbMix.addEventListener('input', ()=>{ rvbVal.textContent=parseFloat(rvbMix.value).toFixed(2); setReverbMix(parseFloat(rvbMix.value), isOn(rvbBtn)); });

  lpfBtn.addEventListener('click', ()=>{ setToggle(lpfBtn,!isOn(lpfBtn)); if(lpfNode) lpfNode.frequency.value=isOn(lpfBtn)?parseFloat(lpfFreq.value):22050; });
  lpfFreq.addEventListener('input', ()=>{ lpfOut.textContent=lpfFreq.value; if(lpfNode) lpfNode.frequency.value=isOn(lpfBtn)?parseFloat(lpfFreq.value):22050; });

  outSl.addEventListener('input', ()=>{ outVal.textContent=parseFloat(outSl.value).toFixed(2); if(masterOut) masterOut.gain.value=parseFloat(outSl.value); });

  presetApply.addEventListener('click', ()=>{ const n=presetSel.value; if(!n){ toast('Pick a built-in preset.'); return; } loadBuiltIn(n); toast(`Loaded: ${n}`); });

  slotSave.addEventListener('click', ()=>{ const idx=parseInt(slotSel.value||'0',10); const slots=getSlots(); const nm=(slotName.value||'').trim()||slots[idx].name||`Slot ${idx+1}`; slots[idx]={name:nm,data:collect()}; putSlots(slots); initSlotsUI(); toast(`Saved to ${nm}`); });
  slotLoad.addEventListener('click', ()=>{ const idx=parseInt(slotSel.value||'0',10); const s=getSlots()[idx]; if(!s.data){ toast('Empty slot'); return; } apply(s.data); toast(`Loaded: ${s.name}`); });
  slotRename.addEventListener('click', ()=>{ const idx=parseInt(slotSel.value||'0',10); const slots=getSlots(); const nm=(slotName.value||'').trim(); if(!nm){ toast('Type a name'); return; } slots[idx].name=nm; putSlots(slots); initSlotsUI(); });
  slotExport.addEventListener('click', ()=>{ const obj={slots:getSlots(), state:collect()}; const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='harp_presets.json'; a.click(); });
  slotImport.addEventListener('click', ()=>importFile.click());
  importFile.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const p=JSON.parse(fr.result); if(p.slots) localStorage.setItem(SLOTS_KEY, JSON.stringify(p.slots)); if(p.state) apply(p.state); initSlotsUI(); toast('Imported.'); }catch{ toast('Invalid file.'); } }; fr.readAsText(f); });
}

/* ========= Hum killer ========= */
function applyHum(){
  const mains=(humMains.value==='50')?50:60;
  const on=isOn(humBtn);
  hum1.type = on ? 'notch' : 'allpass';
  hum2.type = (on && isOn(hum2nd)) ? 'notch' : 'allpass';
  hum1.frequency.value=mains; hum2.frequency.value=mains*2;
}
humBtn.addEventListener('click', ()=>{ setToggle(humBtn,!isOn(humBtn)); if(audioContext) applyHum(); });
hum2nd.addEventListener('click', ()=>{ setToggle(hum2nd,!isOn(hum2nd)); if(audioContext) applyHum(); });
humMains.addEventListener('change', ()=>{ if(audioContext) applyHum(); });

/* ========= Meters ========= */
let rafId;
function startMeters(){
  const postTD=new Uint8Array(postAnalyser.fftSize);
  const preTD =new Uint8Array(preAnalyser.fftSize);
  const ctxV=vuCanvas.getContext('2d'), ctxIn=inCanvas.getContext('2d'), ctxOut=outCanvas.getContext('2d');
  function level(td){ let sum=0; for(let i=0;i<td.length;i++){ const v=(td[i]-128)/128; sum+=v*v; } const rms=Math.sqrt(sum/td.length); return Math.min(1,rms/0.7); }
  function draw(ctx,canvas,n,leds=28){ const w=canvas.clientWidth,h=canvas.clientHeight; ctx.clearRect(0,0,w,h); const pad=6,gap=2,uw=w-pad*2,ledW=(uw-gap*(leds-1))/leds,ledH=Math.max(8,h-6),y=(h-ledH)/2; const act=Math.round(clamp(n,0,1)*leds); for(let i=0;i<leds;i++){ const x=pad+i*(ledW+gap); const pct=i/(leds-1); let col='#22c55e'; if(pct>0.70&&pct<=0.9) col='#eab308'; if(pct>0.9) col='#ef4444'; ctx.fillStyle=i<act?col:'rgba(148,163,184,0.18)'; ctx.fillRect(x,y,ledW,ledH); } }
  function loop(){
    if(!running) return;
    postAnalyser.getByteTimeDomainData(postTD);
    preAnalyser.getByteTimeDomainData(preTD);
    draw(ctxV,vuCanvas, level(postTD));
    draw(ctxOut,outCanvas, level(postTD), 18);
    draw(ctxIn, inCanvas,  level(preTD), 18);
    if(typeof limiter.reduction==='number'){ limGR.textContent=limiter.reduction.toFixed(1); }
    rafId=requestAnimationFrame(loop);
  }
  sizeAllCanvases();
  if(rafId) cancelAnimationFrame(rafId);
  rafId=requestAnimationFrame(loop);
}
function stopMeters(){ if(rafId){ cancelAnimationFrame(rafId); rafId=null; } }
function sizeCanvas(el){ const dpr=Math.max(1,Math.floor(window.devicePixelRatio||1)); const r=el.getBoundingClientRect(); el.width=Math.floor(r.width*dpr); el.height=Math.floor(r.height*dpr); el.getContext('2d').setTransform(dpr,0,0,dpr,0,0); }
function sizeAllCanvases(){ [vuCanvas,inCanvas,outCanvas].forEach(sizeCanvas); }
function clearCanvases(){ [vuCanvas,inCanvas,outCanvas].forEach(c=>{ const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.clientWidth,c.clientHeight); }); }
window.addEventListener('resize', sizeAllCanvases);

/* ========= Gate loop ========= */
function startGateLoop(){
  if(!preAnalyser||!gateGain) return;
  const td=new Uint8Array(preAnalyser.fftSize);
  (function step(){
    if(!running) return;
    preAnalyser.getByteTimeDomainData(td);
    let sum=0; for(let i=0;i<td.length;i++){ const v=(td[i]-128)/128; sum+=v*v; }
    const rms=Math.sqrt(sum/td.length); const dB=linearToDb(rms);
    const thr=parseFloat(gateTh.value), rel=parseFloat(gateRl.value);
    const t=audioContext.currentTime;
    if(isOn(gateBtn)){ if(dB<thr) gateGain.gain.setTargetAtTime(0,t,rel); else gateGain.gain.setTargetAtTime(1,t,0.01); }
    else gateGain.gain.setTargetAtTime(1,t,0.01);
    requestAnimationFrame(step);
  })();
}

/* ========= Presets (built-in) ========= */
const builtIns={
  "Classic Chicago":  ()=>({ drv:true,gain:35,hpf:true,hpfHz:120, hum:false, eq:{l:1,m:1,t:-1}, comp:{th:-24,ra:3.0,at:0.01,re:0.18,mk:2}, dly:{on:true,mix:0.18}, rvb:{on:true,mix:0.16}, lpf:{on:true,hz:9000}, out:1 }),
  "Crunch Amp":       ()=>({ drv:true,gain:48,hpf:true,hpfHz:100, hum:false, eq:{l:2,m:2,t:0},  comp:{th:-20,ra:4.0,at:0.006,re:0.12,mk:2}, dly:{on:false,mix:0.0}, rvb:{on:true,mix:0.14}, lpf:{on:true,hz:8500}, out:0.95 }),
  "Fat Low End":      ()=>({ drv:false,gain:18,hpf:true,hpfHz:80,  hum:false, eq:{l:3,m:-1,t:-2}, comp:{th:-26,ra:2.5,at:0.015,re:0.2,mk:3}, dly:{on:false,mix:0.0}, rvb:{on:true,mix:0.18}, lpf:{on:false,hz:12000}, out:1 }),
  "Bright Cut":       ()=>({ drv:true,gain:22,hpf:true,hpfHz:120, hum:false, eq:{l:-1,m:0,t:2}, comp:{th:-22,ra:2.8,at:0.012,re:0.18,mk:2}, dly:{on:true,mix:0.12}, rvb:{on:true,mix:0.10}, lpf:{on:true,hz:9500}, out:1 }),
  "Little Walter Cup":()=>({ drv:true,gain:28,hpf:true,hpfHz:110, hum:true, eq:{l:1,m:-1,t:-1}, comp:{th:-23,ra:3.0,at:0.010,re:0.16,mk:2}, dly:{on:false,mix:0}, rvb:{on:true,mix:0.14}, lpf:{on:true,hz:9000}, out:1 }),
  "Country Clean":    ()=>({ drv:false,gain:12,hpf:true,hpfHz:100, hum:false, eq:{l:0,m:-1,t:2}, comp:{th:-18,ra:2.2,at:0.006,re:0.12,mk:1}, dly:{on:true,mix:0.16}, rvb:{on:true,mix:0.12}, lpf:{on:false,hz:12000}, out:1 }),
  "Dark Mellow":      ()=>({ drv:false,gain:8, hpf:true,hpfHz:120, hum:false, eq:{l:2,m:-2,t:-3},comp:{th:-24,ra:2.0,at:0.015,re:0.20,mk:3}, dly:{on:false,mix:0}, rvb:{on:true,mix:0.20}, lpf:{on:true,hz:8000}, out:1 }),
  "Lo-Fi Amp":        ()=>({ drv:true,gain:60,hpf:true,hpfHz:140, hum:true,  eq:{l:-3,m:0,t:-2},comp:{th:-26,ra:6.0,at:0.003,re:0.10,mk:4}, dly:{on:false,mix:0}, rvb:{on:false,mix:0}, lpf:{on:true,hz:6500}, out:0.95 }),
  "Big Room":         ()=>({ drv:false,gain:10,hpf:true,hpfHz:80,  hum:false, eq:{l:0,m:0,t:0},  comp:{th:-22,ra:2.5,at:0.010,re:0.18,mk:2}, dly:{on:true,mix:0.22}, rvb:{on:true,mix:0.26}, lpf:{on:false,hz:12000}, out:1 }),
  "Cut Through Band": ()=>({ drv:true,gain:38,hpf:true,hpfHz:120, hum:false, eq:{l:1,m:2,t:2}, comp:{th:-20,ra:3.2,at:0.008,re:0.14,mk:3}, dly:{on:true,mix:0.12}, rvb:{on:true,mix:0.12}, lpf:{on:true,hz:9500}, out:1 }),
  "Modern Blues Rock":()=>({ drv:true,gain:55,hpf:true,hpfHz:130, hum:false, eq:{l:0,m:2,t:1},  comp:{th:-22,ra:4.0,at:0.006,re:0.12,mk:2}, dly:{on:false,mix:0}, rvb:{on:true,mix:0.10}, lpf:{on:true,hz:9000}, out:0.95 }),
  "Vintage Jazz Tone":()=>({ drv:false,gain:10,hpf:true,hpfHz:90,  hum:false, eq:{l:-1,m:-1,t:1}, comp:{th:-24,ra:2.0,at:0.012,re:0.18,mk:2}, dly:{on:false,mix:0}, rvb:{on:true,mix:0.18}, lpf:{on:false,hz:12000}, out:1 }),
  "Country Bright":   ()=>({ drv:false,gain:8, hpf:true,hpfHz:100, hum:false, eq:{l:-1,m:-1,t:3},comp:{th:-20,ra:2.5,at:0.008,re:0.14,mk:1}, dly:{on:true,mix:0.14}, rvb:{on:true,mix:0.12}, lpf:{on:false,hz:12000}, out:1 })
};
function loadBuiltIn(name){
  const f=builtIns[name]; if(!f) return;
  const p=f();
  setToggle(drvBtn, !!p.drv); ampGain.value=p.gain; gainValue.textContent=ampGain.value; if(driveWS){ driveWS.curve=makeDist(parseInt(ampGain.value,10)); driveWet.gain.value=p.drv?1:0; driveDry.gain.value=p.drv?0:1; }
  setToggle(hpfBtn, !!p.hpf); hpfFreq.value=p.hpfHz; hpfVal.textContent=p.hpfHz; if(hpf) hpf.frequency.value = p.hpf ? p.hpfHz : 20;
  setToggle(humBtn, !!p.hum); applyHum();
  if(eqLowNode){ eqLow.value=p.eq.l; eqMid.value=p.eq.m; eqHigh.value=p.eq.t; eqLowVal.textContent=eqLow.value; eqMidVal.textContent=eqMid.value; eqHighVal.textContent=eqHigh.value; eqLowNode.gain.value=parseFloat(eqLow.value); eqMidNode.gain.value=parseFloat(eqMid.value); eqHighNode.gain.value=parseFloat(eqHigh.value); }
  setToggle(compBtn,true); cTh.value=p.comp.th; cRa.value=p.comp.ra; cAt.value=p.comp.at; cRe.value=p.comp.re; cMk.value=p.comp.mk; cThVal.textContent=cTh.value; cRaVal.textContent=parseFloat(cRa.value).toFixed(1); cAtVal.textContent=parseFloat(cAt.value).toFixed(3); cReVal.textContent=parseFloat(cRe.value).toFixed(2); cMkVal.textContent=cMk.value; if(comp){ comp.threshold.value=p.comp.th; comp.ratio.value=p.comp.ra; comp.attack.value=p.comp.at; comp.release.value=p.comp.re; } if(compMakeup) compMakeup.gain.value=dBToLinear(p.comp.mk);
  setToggle(dlyBtn, !!p.dly.on); dlyMix.value=p.dly.mix; dlyVal.textContent=parseFloat(dlyMix.value).toFixed(2); if(dlyWet) dlyWet.gain.value=p.dly.on?p.dly.mix:0;
  setToggle(rvbBtn, !!p.rvb.on); rvbMix.value=p.rvb.mix; rvbVal.textContent=parseFloat(rvbMix.value).toFixed(2); setReverbMix(parseFloat(rvbMix.value), !!p.rvb.on);
  setToggle(lpfBtn, !!p.lpf.on); lpfFreq.value=p.lpf.hz; lpfOut.textContent=p.lpf.hz; if(lpfNode) lpfNode.frequency.value=p.lpf.on?p.lpf.hz:22050;
  outSl.value=p.out; outVal.textContent=parseFloat(outSl.value).toFixed(2); if(masterOut) masterOut.gain.value=parseFloat(outSl.value);
}

/* ========= User Presets ========= */
const SLOTS_KEY='harpSlotsV1';
function emptySlots(){ return Array.from({length:10},(_,i)=>({name:`Slot ${i+1}`, data:null})); }
function getSlots(){ try{ const raw=localStorage.getItem(SLOTS_KEY); if(!raw) return emptySlots(); const p=JSON.parse(raw); return Array.isArray(p)&&p.length===10?p:emptySlots(); }catch{ return emptySlots(); } }
function putSlots(s){ localStorage.setItem(SLOTS_KEY, JSON.stringify(s)); }
function initSlotsUI(){ const slots=getSlots(); slotSel.innerHTML=''; slots.forEach((s,i)=>{ const o=document.createElement('option'); o.value=String(i); o.textContent=s.data?s.name:`${s.name} (empty)`; slotSel.appendChild(o); }); slotGrid.innerHTML=''; slots.forEach((s,i)=>{ const b=document.createElement('button'); b.className='slotbtn'; b.textContent=s.name.length>18?s.name.slice(0,18)+'…':s.name; if(!s.data) b.style.opacity='.55'; b.addEventListener('click',()=>{ const sl=getSlots()[i]; if(!sl.data){ toast('Empty slot'); return; } apply(sl.data); toast(`Loaded: ${sl.name}`); }); slotGrid.appendChild(b); }); }
function collect(){ return {
  mon:monitorSel.value, dsp:isOn(osDSPBtn),
  trim:parseFloat(trimSl.value),
  gate:isOn(gateBtn), gTh:parseFloat(gateTh.value), gRl:parseFloat(gateRl.value),
  hpf:isOn(hpfBtn), hpfHz:parseFloat(hpfFreq.value),
  hum:isOn(humBtn), mains:humMains.value, h2:isOn(hum2nd),
  drv:isOn(drvBtn), gain:parseInt(ampGain.value,10),
  eql:parseFloat(eqLow.value), eqm:parseFloat(eqMid.value), eqh:parseFloat(eqHigh.value),
  cTh:parseFloat(cTh.value), cRa:parseFloat(cRa.value), cAt:parseFloat(cAt.value), cRe:parseFloat(cRe.value), cMk:parseFloat(cMk.value), cOn:isOn(compBtn),
  dly:isOn(dlyBtn), dMix:parseFloat(dlyMix.value),
  rvb:isOn(rvbBtn), rMix:parseFloat(rvbMix.value),
  lpf:isOn(lpfBtn), lpfHz:parseFloat(lpfFreq.value),
  out:parseFloat(outSl.value)
};}
function apply(s){
  monitorSel.value=s.mon||'direct'; setMonitor(monitorSel.value);
  setToggle(osDSPBtn, !!s.dsp);

  trimSl.value=s.trim??0; trimVal.textContent=trimSl.value;

  setToggle(gateBtn, !!s.gate); gateTh.value=s.gTh??-60; gateRl.value=s.gRl??0.18; gateThVal.textContent=gateTh.value; gateRlVal.textContent=parseFloat(gateRl.value).toFixed(2);

  setToggle(hpfBtn, !!s.hpf); hpfFreq.value=s.hpfHz??100; hpfVal.textContent=hpfFreq.value; if(hpf) hpf.frequency.value=isOn(hpfBtn)?parseFloat(hpfFreq.value):20;

  setToggle(humBtn, !!s.hum); humMains.value=s.mains||'60'; setToggle(hum2nd, !!s.h2); applyHum();

  setToggle(drvBtn, !!s.drv); ampGain.value=s.gain??25; gainValue.textContent=ampGain.value; if(driveWS) driveWS.curve=makeDist(parseInt(ampGain.value,10)); if(driveWet&&driveDry){ driveWet.gain.value=isOn(drvBtn)?1:0; driveDry.gain.value=isOn(drvBtn)?0:1; }

  eqLow.value=s.eql??0; eqMid.value=s.eqm??0; eqHigh.value=s.eqh??0; eqLowVal.textContent=eqLow.value; eqMidVal.textContent=eqMid.value; eqHighVal.textContent=eqHigh.value;
  if(eqLowNode){ eqLowNode.gain.value=parseFloat(eqLow.value); eqMidNode.gain.value=parseFloat(eqMid.value); eqHighNode.gain.value=parseFloat(eqHigh.value); }

  setToggle(compBtn, !!s.cOn); cTh.value=s.cTh??-22; cRa.value=s.cRa??3.0; cAt.value=s.cAt??0.012; cRe.value=s.cRe??0.18; cMk.value=s.cMk??2; cThVal.textContent=cTh.value; cRaVal.textContent=parseFloat(cRa.value).toFixed(1); cAtVal.textContent=parseFloat(cAt.value).toFixed(3); cReVal.textContent=parseFloat(cRe.value).toFixed(2); cMkVal.textContent=cMk.value; if(comp){ comp.threshold.value=parseFloat(cTh.value); comp.ratio.value=parseFloat(cRa.value); comp.attack.value=parseFloat(cAt.value); comp.release.value=parseFloat(cRe.value); } if(compMakeup) compMakeup.gain.value=dBToLinear(parseFloat(cMk.value));

  setToggle(dlyBtn, !!s.dly); dlyMix.value=s.dMix??0.2; dlyVal.textContent=parseFloat(dlyMix.value).toFixed(2); if(dlyWet) dlyWet.gain.value=isOn(dlyBtn)?parseFloat(dlyMix.value):0;

  setToggle(rvbBtn, !!s.rvb); rvbMix.value=s.rMix??0.15; rvbVal.textContent=parseFloat(rvbMix.value).toFixed(2); setReverbMix(parseFloat(rvbMix.value), isOn(rvbBtn));

  setToggle(lpfBtn, !!s.lpf); lpfFreq.value=s.lpfHz??9500; lpfOut.textContent=lpfFreq.value; if(lpfNode) lpfNode.frequency.value=isOn(lpfBtn)?parseFloat(lpfFreq.value):22050;

  outSl.value=s.out??1; outVal.textContent=parseFloat(outSl.value).toFixed(2); if(masterOut) masterOut.gain.value=parseFloat(outSl.value);
}

/* ========= Canvas sizing ========= */
function sizeCanvas(el){ const dpr=Math.max(1,Math.floor(window.devicePixelRatio||1)); const r=el.getBoundingClientRect(); el.width=Math.floor(r.width*dpr); el.height=Math.floor(r.height*dpr); el.getContext('2d').setTransform(dpr,0,0,dpr,0,0); }
function sizeAllCanvases(){ [vuCanvas,inCanvas,outCanvas].forEach(sizeCanvas); }
function clearCanvases(){ [vuCanvas,inCanvas,outCanvas].forEach(c=>{ const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.clientWidth,c.clientHeight); }); }
window.addEventListener('resize', sizeAllCanvases);
window.addEventListener('load', ()=>{ sizeAllCanvases(); });
</script>
</body>
</html>
