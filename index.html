<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Guitar & Keys Rig — Amp + Pedalboard</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

<!-- Tailwind (CDN) -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: {
        sans: ['Inter','system-ui','sans-serif'],
        display: ['Orbitron','Inter','system-ui','sans-serif'],
      },
      colors: {
        chrome: { ring:'#20324a' },
        accent: { DEFAULT:'#60a5fa', deep:'#3b82f6' }
      },
      boxShadow: { panel:'0 14px 32px rgba(0,0,0,0.45)' }
    }
  }
}
</script>

<style>
:root{ --slider-h:28px; --slider-track:9px; --thumb:20px; }
.hslider{-webkit-appearance:none;appearance:none;width:100%;height:var(--slider-h);background:transparent;display:block;cursor:pointer;touch-action:pan-y;}
.hslider:focus{outline:none;}
.hslider::-webkit-slider-runnable-track{height:var(--slider-track);border-radius:9999px;background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(0,0,0,.22)),linear-gradient(90deg,#2a3a56,#13233a);box-shadow:inset 0 1px 0 rgba(255,255,255,.10), inset 0 -1px 0 rgba(0,0,0,.45);}
.hslider::-moz-range-track{height:var(--slider-track);border-radius:9999px;background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(0,0,0,.22)),linear-gradient(90deg,#2a3a56,#13233a);box-shadow:inset 0 1px 0 rgba(255,255,255,.10), inset 0 -1px 0 rgba(0,0,0,.45);}
.hslider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:var(--thumb);height:var(--thumb);margin-top:calc((var(--slider-track)-var(--thumb))/2);border-radius:10px;background:radial-gradient(120% 120% at 30% 20%,#fff 0%,#eef6ff 55%,#dbeafe 80%,#bfdbfe 100%);border:1px solid #60a5fa;box-shadow:0 3px 10px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.8), inset 0 -1px 0 rgba(0,0,0,.35);transition:transform .12s, box-shadow .12s, background .15s;}
.hslider:hover::-webkit-slider-thumb{transform:translateY(.2px);}
.hslider:active::-webkit-slider-thumb{transform:translateY(.6px) scale(.98);}
.hslider::-moz-range-thumb{width:var(--thumb);height:var(--thumb);border-radius:10px;background:radial-gradient(120% 120% at 30% 20%,#fff 0%,#eef6ff 55%,#dbeafe 80%,#bfdbfe 100%);border:1px solid #60a5fa;box-shadow:0 3px 10px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.8), inset 0 -1px 0 rgba(0,0,0,.35);}
.toggle-pill{position:relative;display:inline-flex;height:28px;width:56px;align-items:center;border-radius:9999px;background:rgba(2,6,23,.85);box-shadow:inset 0 0 0 1px rgba(100,116,139,.6);}
.toggle-dot{position:absolute;left:4px;top:4px;height:20px;width:20px;border-radius:9999px;background:#f1f5f9;box-shadow:inset 0 1px 0 rgba(255,255,255,.75), inset 0 -1px 0 rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.35);transition:transform .2s;}
.toggle-on{background:#3b82f6;box-shadow:inset 0 0 0 1px rgba(59,130,246,.7);}
.dot-on{transform:translateX(28px);}
#vu-wrap{height:clamp(18px,4.5vw,26px);}
.vu-mini{height:14px;}
canvas{display:block;width:100%;height:100%;}
.slotbtn{ padding:.25rem .5rem; border-radius:.375rem; font-size:11px; background:rgba(15,23,42,.7); border:1px solid rgba(71,85,105,.8); }
#message-box{position:fixed;top:-100px;left:50%;transform:translateX(-50%);background:#ef4444;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 12px 30px rgba(0,0,0,.3);font-weight:700;z-index:1000;transition:top .45s;}
</style>
</head>

<body class="min-h-screen bg-gradient-to-br from-[#0b1a2a] via-[#0d2340] to-[#0a1730] text-slate-100 antialiased">
<div id="message-box">Mic permission needed. Click Start and allow access.</div>

<main class="mx-auto p-3 sm:p-4">
<section class="mx-auto w-full max-w-[360px] sm:max-w-[560px] md:max-w-[900px]
                 rounded-3xl border border-chrome-ring shadow-panel relative overflow-hidden
                 bg-[radial-gradient(140%_120%_at_0%_0%,#1f2f4d_0%,rgba(24,42,76,0.95)_45%,#152a49_100%)]">
  <div class="pointer-events-none absolute inset-0 rounded-3xl" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.10), inset 0 -2px 0 rgba(0,0,0,.45)"></div>

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 border-b border-slate-700/60 px-4 pt-4 pb-3">
    <div>
      <h1 class="font-display text-lg sm:text-xl tracking-wide drop-shadow-[0_0_12px_rgba(96,165,250,0.45)]">GUITAR & KEYS RIG</h1>
      <p class="text-[12px] text-slate-300">Click <strong>Start Audio</strong> to turn it on.</p>
    </div>
    <div class="flex items-center gap-3">
      <button id="btn-start" class="px-3 py-2 rounded-lg text-[12px] font-semibold bg-gradient-to-b from-accent to-accent-deep text-slate-900 ring-1 ring-white/30 hover:brightness-95 active:brightness-90">Start Audio</button>
      <div class="flex items-center gap-2 text-[11px]">
        <span id="status-led" class="inline-block h-3 w-3 rounded-full bg-slate-600 ring-2 ring-slate-900"></span>
        <span id="status-text" class="text-slate-200/90">Off</span>
      </div>
    </div>
  </div>

  <!-- Device + meters -->
  <div class="px-4 pt-2 space-y-2">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div class="flex items-center gap-2">
        <label class="text-[12px]">Input:</label>
        <select id="device-select" class="min-w-[200px] max-w-full flex-1 px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md"></select>
        <button id="device-refresh" class="px-2 py-1 text-[11px] rounded-md bg-slate-900/60 ring-1 ring-slate-600 hover:bg-slate-900">Refresh</button>
      </div>
      <div class="text-[11px] text-slate-200/90 flex items-center gap-3">
        <span id="sr-readout">SR: —</span><span>•</span><span id="lat-readout">Latency: —</span>
      </div>
    </div>

    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <button id="vu-mode" class="px-2 py-0.5 rounded-md text-[11px] ring-1 ring-slate-600 bg-slate-900/60 hover:bg-slate-900">RMS</button>
        <div class="flex items-center gap-1 text-[11px]"><span class="text-slate-200/80">CLIP</span><div id="clip-led" class="h-3 w-3 rounded-full bg-slate-600 ring-2 ring-slate-900"></div></div>
      </div>
      <div class="text-[11px] text-slate-200/90">Limiter GR: <span id="lim-gr">0.0</span> dB</div>
    </div>
    <div id="vu-wrap" class="relative rounded-xl ring-1 ring-slate-700 bg-[#0a1930]/80 overflow-hidden">
      <canvas id="vu-canvas"></canvas>
      <div class="pointer-events-none absolute inset-0 rounded-xl" style="background:linear-gradient(180deg,rgba(255,255,255,.10),transparent 50%,rgba(255,255,255,.06));"></div>
    </div>

    <div class="grid grid-cols-2 gap-2">
      <div class="rounded-md ring-1 ring-slate-700 bg-[#0a1930]/70 px-2 py-1">
        <div class="flex items-center justify-between text-[11px] mb-1"><span>Pre</span><span class="text-slate-400">input</span></div>
        <div class="vu-mini rounded-sm overflow-hidden"><canvas id="in-canvas"></canvas></div>
      </div>
      <div class="rounded-md ring-1 ring-slate-700 bg-[#0a1930]/70 px-2 py-1">
        <div class="flex items-center justify-between text-[11px] mb-1"><span>Post</span><span class="text-slate-400">output</span></div>
        <div class="vu-mini rounded-sm overflow-hidden"><canvas id="out-canvas"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="px-4 pb-5 pt-3 space-y-4">

    <!-- Input/Gate/Trim -->
    <div class="rounded-2xl border border-slate-700 bg-gradient-to-b from-[#19335b] to-[#152a49] p-3" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);">
      <div class="grid grid-cols-12 items-center gap-2">
        <div class="col-span-12 sm:col-span-6">
          <div class="flex items-center justify-between mb-1">
            <div class="text-[12px] uppercase tracking-wider text-slate-100">Input Trim</div>
            <div class="text-xs text-slate-100/90"><span id="trim-val">0</span> dB</div>
          </div>
          <input id="input-trim" class="hslider" type="range" min="-18" max="24" step="0.5" value="0"/>
          <button id="btn-calibrate" class="mt-2 px-2 py-1 text-[11px] rounded-md bg-accent/20 ring-1 ring-accent/40 hover:bg-accent/30">Auto-Cal to −18 dBFS</button>
        </div>
        <div class="col-span-12 sm:col-span-6 mt-3 sm:mt-0">
          <div class="flex items-center justify-between">
            <div class="text-[12px] uppercase tracking-wider text-slate-100">Noise Gate</div>
            <div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="gate-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div>
          </div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Threshold</div><div class="col-span-6"><input id="gate-threshold" class="hslider" type="range" min="-80" max="-20" step="1" value="-60"/></div><div class="col-span-2 text-right text-[11px]"><span id="gate-thresh-val">-60</span> dB</div>
            <div class="col-span-4 text-[11px] mt-2">Release</div><div class="col-span-6 mt-2"><input id="gate-release" class="hslider" type="range" min="0.02" max="0.4" step="0.01" value="0.18"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="gate-rel-val">0.18</span>s</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Amp & Cab -->
    <div class="rounded-2xl border border-slate-700 bg-gradient-to-b from-[#19335b] to-[#152a49] p-3" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);">
      <div class="grid grid-cols-12 gap-2 items-center">
        <div class="col-span-12 md:col-span-6">
          <div class="flex items-center gap-2">
            <label class="text-[12px] uppercase tracking-wider text-slate-100">Amp Model</label>
            <select id="amp-model" class="ml-2 px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md">
              <option value="tweed">Tweed (’50s)</option>
              <option value="blackface">Blackface Clean</option>
              <option value="ac30">Vox AC30</option>
              <option value="plexi">Marshall Plexi</option>
              <option value="modern">Modern High Gain</option>
              <option value="jazz">Jazz Clean (JC)</option>
            </select>
          </div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-3 text-[11px]">Gain</div><div class="col-span-7"><input id="amp-gain" class="hslider" type="range" min="0" max="100" step="1" value="25"/></div><div class="col-span-2 text-right text-[11px]"><span id="amp-gain-val">25</span></div>
            <div class="col-span-3 text-[11px] mt-2">Bass</div><div class="col-span-7 mt-2"><input id="amp-bass" class="hslider" type="range" min="-12" max="12" step="0.5" value="0"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="amp-bass-val">0</span> dB</div>
            <div class="col-span-3 text-[11px] mt-2">Mid</div><div class="col-span-7 mt-2"><input id="amp-mid" class="hslider" type="range" min="-12" max="12" step="0.5" value="0"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="amp-mid-val">0</span> dB</div>
            <div class="col-span-3 text-[11px] mt-2">Treble</div><div class="col-span-7 mt-2"><input id="amp-treble" class="hslider" type="range" min="-12" max="12" step="0.5" value="0"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="amp-treble-val">0</span> dB</div>
            <div class="col-span-3 text-[11px] mt-2">Presence</div><div class="col-span-7 mt-2"><input id="amp-pres" class="hslider" type="range" min="-12" max="12" step="0.5" value="0"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="amp-pres-val">0</span> dB</div>
            <div class="col-span-3 text-[11px] mt-2">Master</div><div class="col-span-7 mt-2"><input id="amp-master" class="hslider" type="range" min="0" max="1.2" step="0.01" value="1"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="amp-master-val">1.00</span></div>
          </div>
        </div>

        <div class="col-span-12 md:col-span-6">
          <div class="flex items-center justify-between">
            <div class="text-[12px] uppercase tracking-wider text-slate-100">Cabinet Sim</div>
            <div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="cab-enable" class="toggle-pill toggle-on"><span class="toggle-dot dot-on"></span></button></div>
          </div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Cab</div>
            <div class="col-span-8">
              <select id="cab-type" class="w-full px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md">
                <option value="1x12">1×12 Combo</option>
                <option value="2x12">2×12</option>
                <option value="4x12" selected>4×12 Stack</option>
              </select>
            </div>
            <div class="col-span-4 text-[11px] mt-2">Air LPF</div><div class="col-span-8 mt-2"><input id="cab-lpf" class="hslider" type="range" min="3000" max="9000" step="100" value="5500"/></div>
          </div>
          <p class="mt-1 text-[11px] text-slate-300/80">Tone stack + cab filters approximate classic responses without heavy IR files.</p>
        </div>
      </div>
    </div>

    <!-- Pedalboard: Pre (Wah, Comp), Drives (OD/Dist/Fuzz), Mods (Chorus/Phaser/Trem), Time (Delay/Reverb) -->
    <!-- Pre -->
    <div class="rounded-2xl border border-slate-700 bg-gradient-to-b from-[#19335b] to-[#152a49] p-3" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);">
      <div class="text-[12px] uppercase tracking-wider text-slate-100 mb-2">Pre</div>
      <div class="grid grid-cols-12 gap-2">
        <!-- Wah -->
        <div class="col-span-12 md:col-span-4">
          <div class="flex items-center justify-between"><div class="text-[12px]">Wah</div><div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="wah-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div></div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Freq</div><div class="col-span-6"><input id="wah-freq" class="hslider" type="range" min="300" max="2500" step="1" value="900"/></div><div class="col-span-2 text-right text-[11px]"><span id="wah-freq-val">900</span> Hz</div>
            <div class="col-span-4 text-[11px] mt-2">Q</div><div class="col-span-6 mt-2"><input id="wah-q" class="hslider" type="range" min="0.3" max="10" step="0.1" value="1.2"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="wah-q-val">1.2</span></div>
          </div>
        </div>
        <!-- Comp -->
        <div class="col-span-12 md:col-span-4">
          <div class="flex items-center justify-between"><div class="text-[12px]">Compressor</div><div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="cmp-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div></div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Thresh</div><div class="col-span-6"><input id="cmp-th" class="hslider" type="range" min="-50" max="0" step="1" value="-24"/></div><div class="col-span-2 text-right text-[11px]"><span id="cmp-th-val">-24</span> dB</div>
            <div class="col-span-4 text-[11px] mt-2">Ratio</div><div class="col-span-6 mt-2"><input id="cmp-ra" class="hslider" type="range" min="1" max="20" step="0.5" value="3.0"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="cmp-ra-val">3.0</span>:1</div>
          </div>
        </div>
        <!-- Gate quick toggle duplicated here for convenience -->
        <div class="col-span-12 md:col-span-4">
          <div class="text-[12px] mb-1">Gate Quick</div>
          <div class="flex items-center gap-2"><button id="gate-quick" class="px-2 py-1 text-[11px] rounded-md bg-slate-900/60 ring-1 ring-slate-600 hover:bg-slate-900">Toggle Gate</button><span class="text-[11px] opacity-80">uses settings above</span></div>
        </div>
      </div>
    </div>

    <!-- Drives -->
    <div class="rounded-2xl border border-slate-700 bg-gradient-to-b from-[#19335b] to-[#152a49] p-3" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);">
      <div class="text-[12px] uppercase tracking-wider text-slate-100 mb-2">Drives</div>
      <div class="grid grid-cols-12 gap-2">
        <!-- Overdrive -->
        <div class="col-span-12 md:col-span-4">
          <div class="flex items-center justify-between"><div class="text-[12px]">Overdrive</div><div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="od-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div></div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Gain</div><div class="col-span-6"><input id="od-gain" class="hslider" type="range" min="0" max="100" step="1" value="20"/></div><div class="col-span-2 text-right text-[11px]"><span id="od-gain-val">20</span></div>
            <div class="col-span-4 text-[11px] mt-2">Tone</div><div class="col-span-6 mt-2"><input id="od-tone" class="hslider" type="range" min="-12" max="12" step="0.5" value="2"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="od-tone-val">2</span> dB</div>
            <div class="col-span-4 text-[11px] mt-2">Mix</div><div class="col-span-6 mt-2"><input id="od-mix" class="hslider" type="range" min="0" max="1" step="0.01" value="1"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="od-mix-val">1.00</span></div>
          </div>
        </div>
        <!-- Distortion -->
        <div class="col-span-12 md:col-span-4">
          <div class="flex items-center justify-between"><div class="text-[12px]">Distortion</div><div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="dist-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div></div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Gain</div><div class="col-span-6"><input id="dist-gain" class="hslider" type="range" min="0" max="100" step="1" value="35"/></div><div class="col-span-2 text-right text-[11px]"><span id="dist-gain-val">35</span></div>
            <div class="col-span-4 text-[11px] mt-2">Tone</div><div class="col-span-6 mt-2"><input id="dist-tone" class="hslider" type="range" min="-12" max="12" step="0.5" value="0"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="dist-tone-val">0</span> dB</div>
            <div class="col-span-4 text-[11px] mt-2">Mix</div><div class="col-span-6 mt-2"><input id="dist-mix" class="hslider" type="range" min="0" max="1" step="0.01" value="1"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="dist-mix-val">1.00</span></div>
          </div>
        </div>
        <!-- Fuzz -->
        <div class="col-span-12 md:col-span-4">
          <div class="flex items-center justify-between"><div class="text-[12px]">Fuzz</div><div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="fuzz-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div></div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Gain</div><div class="col-span-6"><input id="fuzz-gain" class="hslider" type="range" min="0" max="100" step="1" value="50"/></div><div class="col-span-2 text-right text-[11px]"><span id="fuzz-gain-val">50</span></div>
            <div class="col-span-4 text-[11px] mt-2">Tone</div><div class="col-span-6 mt-2"><input id="fuzz-tone" class="hslider" type="range" min="-12" max="12" step="0.5" value="-2"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="fuzz-tone-val">-2</span> dB</div>
            <div class="col-span-4 text-[11px] mt-2">Mix</div><div class="col-span-6 mt-2"><input id="fuzz-mix" class="hslider" type="range" min="0" max="1" step="0.01" value="1"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="fuzz-mix-val">1.00</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mods -->
    <div class="rounded-2xl border border-slate-700 bg-gradient-to-b from-[#19335b] to-[#152a49] p-3" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);">
      <div class="text-[12px] uppercase tracking-wider text-slate-100 mb-2">Modulation</div>
      <div class="grid grid-cols-12 gap-2">
        <!-- Chorus -->
        <div class="col-span-12 md:col-span-4">
          <div class="flex items-center justify-between"><div class="text-[12px]">Chorus</div><div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="chorus-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div></div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Rate</div><div class="col-span-6"><input id="chorus-rate" class="hslider" type="range" min="0.05" max="5" step="0.01" value="1.3"/></div><div class="col-span-2 text-right text-[11px]"><span id="chorus-rate-val">1.30</span> Hz</div>
            <div class="col-span-4 text-[11px] mt-2">Depth</div><div class="col-span-6 mt-2"><input id="chorus-depth" class="hslider" type="range" min="0" max="1" step="0.01" value="0.35"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="chorus-depth-val">0.35</span></div>
            <div class="col-span-4 text-[11px] mt-2">Mix</div><div class="col-span-6 mt-2"><input id="chorus-mix" class="hslider" type="range" min="0" max="1" step="0.01" value="0.25"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="chorus-mix-val">0.25</span></div>
          </div>
        </div>
        <!-- Phaser -->
        <div class="col-span-12 md:col-span-4">
          <div class="flex items-center justify-between"><div class="text-[12px]">Phaser</div><div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="phaser-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div></div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Rate</div><div class="col-span-6"><input id="phaser-rate" class="hslider" type="range" min="0.05" max="5" step="0.01" value="0.7"/></div><div class="col-span-2 text-right text-[11px]"><span id="phaser-rate-val">0.70</span> Hz</div>
            <div class="col-span-4 text-[11px] mt-2">Depth</div><div class="col-span-6 mt-2"><input id="phaser-depth" class="hslider" type="range" min="0" max="1" step="0.01" value="0.7"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="phaser-depth-val">0.70</span></div>
            <div class="col-span-4 text-[11px] mt-2">Mix</div><div class="col-span-6 mt-2"><input id="phaser-mix" class="hslider" type="range" min="0" max="1" step="0.01" value="0.25"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="phaser-mix-val">0.25</span></div>
          </div>
        </div>
        <!-- Tremolo -->
        <div class="col-span-12 md:col-span-4">
          <div class="flex items-center justify-between"><div class="text-[12px]">Tremolo</div><div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="trem-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div></div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Rate</div><div class="col-span-6"><input id="trem-rate" class="hslider" type="range" min="0.1" max="12" step="0.1" value="4.0"/></div><div class="col-span-2 text-right text-[11px]"><span id="trem-rate-val">4.0</span> Hz</div>
            <div class="col-span-4 text-[11px] mt-2">Depth</div><div class="col-span-6 mt-2"><input id="trem-depth" class="hslider" type="range" min="0" max="1" step="0.01" value="0.6"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="trem-depth-val">0.60</span></div>
            <div class="col-span-4 text-[11px] mt-2">Mix</div><div class="col-span-6 mt-2"><input id="trem-mix" class="hslider" type="range" min="0" max="1" step="0.01" value="0.8"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="trem-mix-val">0.80</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Time -->
    <div class="rounded-2xl border border-slate-700 bg-gradient-to-b from-[#19335b] to-[#152a49] p-3" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);">
      <div class="text-[12px] uppercase tracking-wider text-slate-100 mb-2">Time</div>
      <div class="grid grid-cols-12 gap-2">
        <!-- Delay -->
        <div class="col-span-12 md:col-span-6">
          <div class="flex items-center justify-between"><div class="text-[12px]">Delay</div><div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="dly-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div></div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-3 text-[11px]">Time</div><div class="col-span-7"><input id="dly-time" class="hslider" type="range" min="0.05" max="1.0" step="0.005" value="0.38"/></div><div class="col-span-2 text-right text-[11px]"><span id="dly-time-val">0.38</span>s</div>
            <div class="col-span-3 text-[11px] mt-2">Feedback</div><div class="col-span-7 mt-2"><input id="dly-fb" class="hslider" type="range" min="0" max="0.9" step="0.01" value="0.35"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="dly-fb-val">0.35</span></div>
            <div class="col-span-3 text-[11px] mt-2">Mix</div><div class="col-span-7 mt-2"><input id="dly-mix" class="hslider" type="range" min="0" max="1" step="0.01" value="0.22"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="dly-mix-val">0.22</span></div>
          </div>
        </div>
        <!-- Reverb -->
        <div class="col-span-12 md:col-span-6">
          <div class="flex items-center justify-between"><div class="text-[12px]">Reverb</div><div class="flex items-center gap-2"><span class="text-[11px]">On</span><button id="rvb-enable" class="toggle-pill"><span class="toggle-dot"></span></button></div></div>
          <div class="mt-2 grid grid-cols-12 items-center gap-2">
            <div class="col-span-3 text-[11px]">Mix</div><div class="col-span-7"><input id="rvb-mix" class="hslider" type="range" min="0" max="1" step="0.01" value="0.18"/></div><div class="col-span-2 text-right text-[11px]"><span id="rvb-mix-val">0.18</span></div>
            <div class="col-span-3 text-[11px] mt-2">Len</div><div class="col-span-7 mt-2"><input id="rvb-len" class="hslider" type="range" min="0.4" max="4" step="0.1" value="2.2"/></div><div class="col-span-2 text-right text-[11px] mt-2"><span id="rvb-len-val">2.2</span>s</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Output / Presets -->
    <div class="rounded-2xl border border-slate-700 bg-gradient-to-b from-[#19335b] to-[#152a49] p-3" style="box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);">
      <div class="grid grid-cols-12 items-center gap-2">
        <div class="col-span-12 md:col-span-6">
          <div class="grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px] uppercase tracking-wider text-slate-100">Output Level</div>
            <div class="col-span-6"><input id="out-level" class="hslider" type="range" min="0" max="1.2" step="0.01" value="1"/></div>
            <div class="col-span-2 text-right text-[11px]"><span id="out-level-val">1.00</span></div>
            <div class="col-span-12 text-[11px] text-slate-300/80 mt-1">Hard limiter engaged post-chain to prevent overs.</div>
          </div>
        </div>

        <div class="col-span-12 md:col-span-6">
          <div class="grid grid-cols-12 items-center gap-2">
            <div class="col-span-12">
              <div class="flex items-center gap-2">
                <select id="preset-select" class="w-full px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md">
                  <option value="">— Built-in Presets —</option>
                  <option>Clean JC</option>
                  <option>Edge AC30</option>
                  <option>Crunch Plexi</option>
                  <option>Texas Tweed</option>
                  <option>Modern Metal</option>
                  <option>Ambient Wash</option>
                  <option>Funk Wah</option>
                </select>
                <button id="preset-apply" class="px-2 py-1 text-[11px] rounded-md bg-slate-900/60 ring-1 ring-slate-600 hover:bg-slate-900">Load</button>
              </div>
            </div>

            <div class="col-span-12 mt-2">
              <div class="flex flex-col sm:flex-row gap-2">
                <select id="user-slot-select" class="flex-1 px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md"></select>
                <div class="flex gap-2">
                  <button id="slot-load"  class="slotbtn">Load</button>
                  <button id="slot-save"  class="px-2 py-1 text-[11px] rounded-md bg-accent/20 ring-1 ring-accent/40 hover:bg-accent/30">Save</button>
                  <button id="slot-rename"class="slotbtn">Rename</button>
                  <button id="slot-export"class="slotbtn">Export</button>
                  <button id="slot-import"class="slotbtn">Import</button>
                  <input id="import-file" type="file" accept="application/json" class="hidden"/>
                </div>
              </div>
              <p class="mt-1 text-[11px] text-slate-300/80">10 user slots, local storage. Export for gigs.</p>
              <div class="mt-2 grid grid-cols-2 sm:grid-cols-5 gap-2" id="slot-grid"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</section>
</main>

<script>
/* ===== Utils ===== */
const dBToLinear = d => Math.pow(10, d/20);
const linearToDb = x => (x>0?20*Math.log10(x): -Infinity);
const $ = id => document.getElementById(id);
function toast(m){ const b=$('message-box'); b.textContent=m; b.style.top='20px'; setTimeout(()=>b.style.top='-100px', 3000); }
function isOn(btn){ return btn.classList.contains('toggle-on'); }
function setToggle(btn,on){ btn.classList.toggle('toggle-on',on); const dot=btn.querySelector('.toggle-dot'); if(dot) dot.classList.toggle('dot-on',on); }

/* ===== Audio State ===== */
let ctx, streamSrc, isRunning=false, deviceId=null;

/* Nodes */
let inputTrim, preAnalyser, gateGain;
let wah, wahGain;
let cmp;
let odShaper, odPre, odTone, odWet, odDry;
let distShaper, distPre, distTone, distWet, distDry;
let fuzzShaper, fuzzPre, fuzzTone, fuzzWet, fuzzDry;
let ampPre, ampEQBass, ampEQMid, ampEQTreble, ampPresence;
let cabHPF, cabLPF, cabPeaker;
let chorusDelay, chorusLFO, chorusDepthGain, chorusWet, chorusDry;
let phaserAP = [], phaserLFO, phaserDepthGain, phaserWet, phaserDry;
let tremLFO, tremDepthGain, tremWet, tremDry;
let delay, delayFB, delayWet, delayDry;
let reverb, rvbWet, rvbDry;
let limiter, ampMaster, outGain, postAnalyser;

/* Meters */
let rafId, vuMode='rms', clipHold=null;
const vuCanvas=$('vu-canvas'), inCanvas=$('in-canvas'), outCanvas=$('out-canvas');
const clipLED=$('clip-led'), limGR=$('lim-gr');

/* UI refs */
const btnStart=$('btn-start'), statusLed=$('status-led'), statusText=$('status-text');
const devSel=$('device-select'), devRef=$('device-refresh');
const srOut=$('sr-readout'), latOut=$('lat-readout');

const trimSl=$('input-trim'), trimVal=$('trim-val'), btnCal=$('btn-calibrate');
const gateBtn=$('gate-enable'), gateTh=$('gate-threshold'), gateRel=$('gate-release'), gateThVal=$('gate-thresh-val'), gateRelVal=$('gate-rel-val');

const wahBtn=$('wah-enable'), wahFreq=$('wah-freq'), wahFreqVal=$('wah-freq-val'), wahQ=$('wah-q'), wahQVal=$('wah-q-val');

const cmpBtn=$('cmp-enable'), cmpTh=$('cmp-th'), cmpRa=$('cmp-ra'), cmpThVal=$('cmp-th-val'), cmpRaVal=$('cmp-ra-val');

const odBtn=$('od-enable'), odGain=$('od-gain'), odGainVal=$('od-gain-val'), odToneSl=$('od-tone'), odToneVal=$('od-tone-val'), odMix=$('od-mix'), odMixVal=$('od-mix-val');
const distBtn=$('dist-enable'), distGain=$('dist-gain'), distGainVal=$('dist-gain-val'), distToneSl=$('dist-tone'), distToneVal=$('dist-tone-val'), distMix=$('dist-mix'), distMixVal=$('dist-mix-val');
const fuzzBtn=$('fuzz-enable'), fuzzGain=$('fuzz-gain'), fuzzGainVal=$('fuzz-gain-val'), fuzzToneSl=$('fuzz-tone'), fuzzToneVal=$('fuzz-tone-val'), fuzzMix=$('fuzz-mix'), fuzzMixVal=$('fuzz-mix-val');

const ampModel=$('amp-model'), ampGain=$('amp-gain'), ampGainVal=$('amp-gain-val'), ampBass=$('amp-bass'), ampBassVal=$('amp-bass-val'), ampMid=$('amp-mid'), ampMidVal=$('amp-mid-val'), ampTreble=$('amp-treble'), ampTrebleVal=$('amp-treble-val'), ampPres=$('amp-pres'), ampPresVal=$('amp-pres-val'), ampMasterSl=$('amp-master'), ampMasterVal=$('amp-master-val');

const cabBtn=$('cab-enable'), cabType=$('cab-type'), cabLPFSl=$('cab-lpf');

const chorBtn=$('chorus-enable'), chorRate=$('chorus-rate'), chorRateVal=$('chorus-rate-val'), chorDepth=$('chorus-depth'), chorDepthVal=$('chorus-depth-val'), chorMix=$('chorus-mix'), chorMixVal=$('chorus-mix-val');
const phsBtn=$('phaser-enable'), phsRate=$('phaser-rate'), phsRateVal=$('phaser-rate-val'), phsDepth=$('phaser-depth'), phsDepthVal=$('phaser-depth-val'), phsMix=$('phaser-mix'), phsMixVal=$('phaser-mix-val');
const trmBtn=$('trem-enable'), trmRate=$('trem-rate'), trmRateVal=$('trem-rate-val'), trmDepth=$('trem-depth'), trmDepthVal=$('trem-depth-val'), trmMix=$('trem-mix'), trmMixVal=$('trem-mix-val');

const dlyBtn=$('dly-enable'), dlyTime=$('dly-time'), dlyTimeVal=$('dly-time-val'), dlyFBSl=$('dly-fb'), dlyFBVal=$('dly-fb-val'), dlyMix=$('dly-mix'), dlyMixVal=$('dly-mix-val');
const rvbBtn=$('rvb-enable'), rvbMix=$('rvb-mix'), rvbMixVal=$('rvb-mix-val'), rvbLen=$('rvb-len'), rvbLenVal=$('rvb-len-val');

const outLevel=$('out-level'), outLevelVal=$('out-level-val');

const presetSel=$('preset-select'), presetApply=$('preset-apply');
const slotSel=$('user-slot-select'), slotLoad=$('slot-load'), slotSave=$('slot-save'), slotRename=$('slot-rename');
const slotExport=$('slot-export'), slotImport=$('slot-import'), importFile=$('import-file');
const slotGrid=$('slot-grid');

/* ===== Start/Stop ===== */
btnStart.addEventListener('click', ()=>{ if(!isRunning) startAudio(); else stopAudio(); });

async function startAudio(){
  try{
    if(!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)();
    srOut.textContent = `SR: ${ctx.sampleRate} Hz`;
    const lat=(ctx.baseLatency||0)+(ctx.outputLatency||0); latOut.textContent=`Latency: ${Math.round(lat*1000)} ms`;

    const constraints = { audio: deviceId ? { deviceId:{ exact: deviceId } } : true };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    streamSrc = ctx.createMediaStreamSource(stream);

    await populateDevices();

    buildGraph();
    wireGraph();

    isRunning=true;
    btnStart.textContent='Stop Audio';
    statusText.textContent='On';
    statusLed.style.backgroundColor='#22c55e';

    sizeAllCanvases(); startLoops();
    initUserSlotsUI();
    applyPreset(BUILTINS['Clean JC']); // default
  }catch(e){
    console.error(e);
    toast('Mic permission needed. Click Start and allow.');
  }
}
function stopAudio(){
  stopLoops();
  if(streamSrc && streamSrc.mediaStream) streamSrc.mediaStream.getTracks().forEach(t=>t.stop());
  if(ctx && ctx.state!=='closed') ctx.close().then(()=>{ ctx=null; });
  isRunning=false;
  btnStart.textContent='Start Audio'; statusText.textContent='Off'; statusLed.style.backgroundColor='#64748b';
  clearCanvases();
}

/* ===== Devices ===== */
async function populateDevices(){
  try{
    const devs = await navigator.mediaDevices.enumerateDevices();
    const ins = devs.filter(d=>d.kind==='audioinput');
    devSel.innerHTML='';
    ins.forEach((d,i)=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||`Input ${i+1}`; devSel.appendChild(o); });
    const pref=localStorage.getItem('rigPreferredDevice'); const t=deviceId||pref;
    if(t){ const f=[...devSel.options].find(o=>o.value===t); if(f) devSel.value=t; }
  }catch(e){ console.warn(e); }
}
devRef.addEventListener('click', async()=>{ await populateDevices(); toast('Device list refreshed.'); });
devSel.addEventListener('change', ()=>{ deviceId=devSel.value||null; localStorage.setItem('rigPreferredDevice', deviceId||''); if(isRunning){ stopAudio(); startAudio(); } });
navigator.mediaDevices?.addEventListener?.('devicechange', populateDevices);

/* ===== Build Graph ===== */
function makeShaper(amount, type='soft'){
  const n=44100, c=new Float32Array(n); const k = amount;
  for(let i=0;i<n;i++){ const x = (i*2/n)-1;
    if(type==='fuzz'){ c[i] = Math.tanh(k*1.5 * Math.sin(x*Math.PI)); }
    else if(type==='hard'){ c[i] = (3+k)*x/ (3+Math.abs(k*x)); }
    else { c[i] = (3+k)*x*0.5 / (1 + k*Math.abs(x)); }
  }
  return c;
}
function buildGraph(){
  // pre
  inputTrim = ctx.createGain(); inputTrim.gain.value = dBToLinear(parseFloat(trimSl.value));
  preAnalyser = ctx.createAnalyser(); preAnalyser.fftSize = 2048;

  // Gate
  gateGain = ctx.createGain(); gateGain.gain.value=1;

  // Wah (bandpass -> gain)
  wah = ctx.createBiquadFilter(); wah.type='bandpass'; wah.frequency.value = parseFloat(wahFreq.value); wah.Q.value = parseFloat(wahQ.value);
  wahGain = ctx.createGain();

  // Compressor
  cmp = ctx.createDynamicsCompressor(); cmp.threshold.value=parseFloat(cmpTh.value); cmp.ratio.value=parseFloat(cmpRa.value); cmp.attack.value=0.01; cmp.release.value=0.15;

  // Drives (parallel wet/dry per pedal, then sum)
  // Overdrive
  odPre = ctx.createGain(); odPre.gain.value=1;
  odShaper = ctx.createWaveShaper(); odShaper.curve = makeShaper(parseInt(odGain.value,10), 'soft'); odShaper.oversample='4x';
  odTone = ctx.createBiquadFilter(); odTone.type='highshelf'; odTone.frequency.value=3000; odTone.gain.value=parseFloat(odToneSl.value);
  odWet = ctx.createGain(); odDry = ctx.createGain(); odWet.gain.value=parseFloat(odMix.value); odDry.gain.value=1-parseFloat(odMix.value);

  // Distortion
  distPre = ctx.createGain(); distPre.gain.value=1;
  distShaper = ctx.createWaveShaper(); distShaper.curve = makeShaper(parseInt(distGain.value,10), 'hard'); distShaper.oversample='4x';
  distTone = ctx.createBiquadFilter(); distTone.type='highshelf'; distTone.frequency.value=3000; distTone.gain.value=parseFloat(distToneSl.value);
  distWet = ctx.createGain(); distDry = ctx.createGain(); distWet.gain.value=parseFloat(distMix.value); distDry.gain.value=1-parseFloat(distMix.value);

  // Fuzz
  fuzzPre = ctx.createGain(); fuzzPre.gain.value=1;
  fuzzShaper = ctx.createWaveShaper(); fuzzShaper.curve = makeShaper(parseInt(fuzzGain.value,10), 'fuzz'); fuzzShaper.oversample='4x';
  fuzzTone = ctx.createBiquadFilter(); fuzzTone.type='lowshelf'; fuzzTone.frequency.value=250; fuzzTone.gain.value=parseFloat(fuzzToneSl.value);
  fuzzWet = ctx.createGain(); fuzzDry = ctx.createGain(); fuzzWet.gain.value=parseFloat(fuzzMix.value); fuzzDry.gain.value=1-parseFloat(fuzzMix.value);

  // Amp pre + tone stack + presence
  ampPre = ctx.createWaveShaper(); ampPre.curve = makeAmpCurve('blackface', parseInt(ampGain.value,10));
  ampEQBass = ctx.createBiquadFilter(); ampEQBass.type='lowshelf'; ampEQBass.frequency.value=100; ampEQBass.gain.value=parseFloat(ampBass.value);
  ampEQMid  = ctx.createBiquadFilter(); ampEQMid.type='peaking'; ampEQMid.frequency.value=800; ampEQMid.Q.value=0.7; ampEQMid.gain.value=parseFloat(ampMid.value);
  ampEQTreble=ctx.createBiquadFilter(); ampEQTreble.type='highshelf'; ampEQTreble.frequency.value=3000; ampEQTreble.gain.value=parseFloat(ampTreble.value);
  ampPresence=ctx.createBiquadFilter(); ampPresence.type='highshelf'; ampPresence.frequency.value=4500; ampPresence.gain.value=parseFloat(ampPres.value);
  ampMaster = ctx.createGain(); ampMaster.gain.value=parseFloat(ampMasterSl.value);

  // Cab sim (HPF+LPF+peak dip)
  cabHPF = ctx.createBiquadFilter(); cabHPF.type='highpass'; cabHPF.frequency.value=70;
  cabLPF = ctx.createBiquadFilter(); cabLPF.type='lowpass'; cabLPF.frequency.value=parseFloat(cabLPFSl.value);
  cabPeaker = ctx.createBiquadFilter(); cabPeaker.type='peaking'; cabPeaker.frequency.value=3000; cabPeaker.Q.value=1.2; cabPeaker.gain.value=-4;

  // Chorus
  chorusDelay = ctx.createDelay(0.05); chorusDelay.delayTime.value=0.018;
  chorusLFO = ctx.createOscillator(); chorusLFO.frequency.value=parseFloat(chorRate.value);
  chorusDepthGain = ctx.createGain(); chorusDepthGain.gain.value = parseFloat(chorDepth.value)*0.012; // mod depth in seconds
  chorusWet = ctx.createGain(); chorusWet.gain.value=parseFloat(chorMix.value);
  chorusDry = ctx.createGain(); chorusDry.gain.value=1-parseFloat(chorMix.value);
  chorusLFO.connect(chorusDepthGain).connect(chorusDelay.delayTime);
  chorusLFO.start();

  // Phaser (4 allpass, modded)
  for(let i=0;i<4;i++){ const ap=ctx.createBiquadFilter(); ap.type='allpass'; ap.frequency.value=700*(i+1); phaserAP.push(ap); }
  phaserLFO=ctx.createOscillator(); phaserLFO.frequency.value=parseFloat(phsRate.value);
  phaserDepthGain=ctx.createGain(); phaserDepthGain.gain.value = parseFloat(phsDepth.value)*500; // move frequency by ±depth*500
  phaserLFO.connect(phaserDepthGain);
  phaserLFO.start();
  phaserWet=ctx.createGain(); phaserWet.gain.value=parseFloat(phsMix.value);
  phaserDry=ctx.createGain(); phaserDry.gain.value=1-parseFloat(phsMix.value);

  // Tremolo (gain LFO)
  tremLFO=ctx.createOscillator(); tremLFO.frequency.value=parseFloat(trmRate.value);
  tremDepthGain=ctx.createGain(); tremDepthGain.gain.value=parseFloat(trmDepth.value)*0.5; // amplitude
  tremWet=ctx.createGain(); tremWet.gain.value=parseFloat(trmMix.value);
  tremDry=ctx.createGain(); tremDry.gain.value=1-parseFloat(trmMix.value);
  tremLFO.connect(tremDepthGain); tremLFO.start();

  // Delay
  delay = ctx.createDelay(1.0); delay.delayTime.value=parseFloat(dlyTime.value);
  delayFB = ctx.createGain(); delayFB.gain.value=parseFloat(dlyFBSl.value);
  delayWet = ctx.createGain(); delayWet.gain.value=parseFloat(dlyMix.value);
  delayDry = ctx.createGain(); delayDry.gain.value=1-parseFloat(dlyMix.value);
  delay.connect(delayFB).connect(delay);

  // Reverb (simple generated IR)
  reverb = ctx.createConvolver(); reverb.buffer = makeIR(parseFloat(rvbLen.value));
  rvbWet = ctx.createGain(); rvbDry = ctx.createGain();
  setReverbMix(parseFloat(rvbMix.value), isOn(rvbBtn));

  // Limiter + output + meters
  limiter = ctx.createDynamicsCompressor(); limiter.threshold.value=-1; limiter.knee.value=0; limiter.ratio.value=20; limiter.attack.value=0.002; limiter.release.value=0.08;
  outGain = ctx.createGain(); outGain.gain.value=parseFloat(outLevel.value);
  postAnalyser = ctx.createAnalyser(); postAnalyser.fftSize=2048;
}
function wireGraph(){
  // input
  streamSrc.connect(inputTrim);
  inputTrim.connect(preAnalyser);
  inputTrim.connect(gateGain);

  // gate control loop uses preAnalyser -> gateGain.gain

  // Wah (if off, just pass)
  gateGain.connect(wah);
  wah.connect(wahGain);

  // Compressor
  wahGain.connect(cmp);

  // Drives: split to each pedal wet/dry and sum
  const driveSum = ctx.createGain();

  // OD
  cmp.connect(odPre);
  odPre.connect(odShaper); odShaper.connect(odTone); odTone.connect(odWet);
  cmp.connect(odDry);
  odWet.connect(driveSum); odDry.connect(driveSum);
  // Dist
  cmp.connect(distPre);
  distPre.connect(distShaper); distShaper.connect(distTone); distTone.connect(distWet);
  cmp.connect(distDry);
  distWet.connect(driveSum); distDry.connect(driveSum);
  // Fuzz
  cmp.connect(fuzzPre);
  fuzzPre.connect(fuzzShaper); fuzzShaper.connect(fuzzTone); fuzzTone.connect(fuzzWet);
  cmp.connect(fuzzDry);
  fuzzWet.connect(driveSum); fuzzDry.connect(driveSum);

  // Amp + tone + presence + master
  driveSum.connect(ampPre);
  ampPre.connect(ampEQBass); ampEQBass.connect(ampEQMid); ampEQMid.connect(ampEQTreble); ampEQTreble.connect(ampPresence); ampPresence.connect(ampMaster);

  // Cab section
  const cabOut = ctx.createGain();
  ampMaster.connect(cabHPF); cabHPF.connect(cabPeaker); cabPeaker.connect(cabLPF); cabLPF.connect(cabOut);

  // Chorus (parallel)
  const modBus = ctx.createGain();
  cabOut.connect(chorusDelay); chorusDelay.connect(chorusWet);
  cabOut.connect(chorusDry);
  chorusWet.connect(modBus); chorusDry.connect(modBus);

  // Phaser (parallel)
  const phIn = ctx.createGain(); const phOut = ctx.createGain();
  modBus.connect(phIn);
  phIn.connect(phaserAP[0]); phaserAP[0].connect(phaserAP[1]); phaserAP[1].connect(phaserAP[2]); phaserAP[2].connect(phaserAP[3]); phaserAP[3].connect(phOut);
  const phMix = ctx.createGain();
  phOut.connect(phaserWet); phIn.connect(phaserDry);
  phaserWet.connect(phMix); phaserDry.connect(phMix);

  // Tremolo (parallel gain mod)
  const trIn = ctx.createGain(); const trGain = ctx.createGain(); const trOut = ctx.createGain();
  phMix.connect(trIn);
  // trem gain = 1 - depth + depth * (0.5 + 0.5*sin)
  const dc = ctx.createConstantSource(); dc.offset.value=1.0; dc.start();
  const osc = tremLFO; // already started
  // build signal: base=1-depth, lfoScaled=depth*sin -> sum
  const base = ctx.createGain(); base.gain.value=1 - parseFloat(trmDepth.value)*0.5;
  const lfoScale = ctx.createGain(); lfoScale.gain.value = parseFloat(trmDepth.value)*0.5;
  dc.connect(base);
  osc.connect(lfoScale);
  const summer = ctx.createGain(); base.connect(summer); lfoScale.connect(summer);
  summer.connect(trGain.gain);

  trIn.connect(trGain); trGain.connect(tremWet);
  trIn.connect(tremDry);
  tremWet.connect(trOut); tremDry.connect(trOut);

  // Delay (parallel)
  const timeBus = ctx.createGain();
  trOut.connect(delay); delay.connect(delayWet); trOut.connect(delayDry);
  delayWet.connect(timeBus); delayDry.connect(timeBus);

  // Reverb (parallel)
  timeBus.connect(rvbDry); timeBus.connect(reverb); reverb.connect(rvbWet);

  // Master → limiter → post → destination
  const masterSum = ctx.createGain();
  rvbDry.connect(masterSum); rvbWet.connect(masterSum);
  masterSum.connect(limiter);
  limiter.connect(outGain);
  outGain.connect(postAnalyser);
  outGain.connect(ctx.destination);

  // LFO wiring for phaser frequency modulation
  phaserAP.forEach((ap,i)=>{
    const base = 500 + i*300;
    phaserDepthGain.connect(ap.frequency);
    ap.frequency.value = base;
  });
}

/* ===== Generators ===== */
function makeAmpCurve(name, gainAmt){
  const n=44100, a=new Float32Array(n);
  const k = Math.max(1, gainAmt);
  for(let i=0;i<n;i++){
    const x = (i*2/n)-1;
    let y;
    switch(name){
      case 'tweed':      y = Math.tanh(x * (1 + k*0.03)); break;
      case 'blackface':  y = (3+k)*x*0.5 / (1 + k*Math.abs(x)); break;
      case 'ac30':       y = Math.tanh(x*(1 + k*0.04)) + 0.15*x; break;
      case 'plexi':      y = (3+k)*x / (3 + Math.abs(k*x)) + 0.05*x; break;
      case 'modern':     y = Math.tanh(x*(1 + k*0.07)); break;
      case 'jazz':       y = x * 0.9; break;
      default: y = x;
    }
    a[i]=y;
  }
  return a;
}
function makeIR(seconds){
  const dur = Math.max(0.4, Math.min(4, seconds||2));
  const sr = ctx.sampleRate, len = Math.floor(sr*dur);
  const ir = ctx.createBuffer(2, len, sr);
  for(let ch=0; ch<2; ch++){
    const d = ir.getChannelData(ch);
    for(let i=0;i<len;i++){
      const t = i/len;
      const decay = Math.pow(1-t, 2.0);
      d[i] = (Math.random()*2-1) * decay * 0.6;
    }
  }
  return ir;
}

/* ===== Loops/Meters ===== */
function startLoops(){ startMainLoop(); startGateLoop(); }
function stopLoops(){ if(rafId){ cancelAnimationFrame(rafId); rafId=null; } }
function startMainLoop(){
  const tdPost = new Uint8Array(postAnalyser.fftSize);
  const tdPre  = new Uint8Array(preAnalyser.fftSize);
  const ctxVU = vuCanvas.getContext('2d');
  const ctxIn = inCanvas.getContext('2d');
  const ctxOut= outCanvas.getContext('2d');

  const loop=()=>{
    postAnalyser.getByteTimeDomainData(tdPost);
    preAnalyser.getByteTimeDomainData(tdPre);

    const postLevel = calcLevel(tdPost, vuMode);
    const preLevel  = calcLevel(tdPre, 'rms');

    drawLEDBar(ctxVU, vuCanvas, postLevel);
    drawLEDBar(ctxIn, inCanvas, preLevel, 18);
    drawLEDBar(ctxOut, outCanvas, postLevel, 18);

    const pk = peakFromTD(tdPost);
    if(pk>0.99){ clipLED.style.backgroundColor='#ef4444'; if(clipHold) clearTimeout(clipHold); clipHold=setTimeout(()=>clipLED.style.backgroundColor='#64748b',500); }

    const red = (limiter && typeof limiter.reduction==='number') ? limiter.reduction : 0;
    $('lim-gr').textContent=(red||0).toFixed(1);

    rafId = requestAnimationFrame(loop);
  };
  if(rafId) cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(loop);
}
function startGateLoop(){
  const td = new Uint8Array(preAnalyser.fftSize);
  const loop=()=>{
    if(!ctx) return;
    preAnalyser.getByteTimeDomainData(td);
    let sum=0; for(let i=0;i<td.length;i++){ const v=(td[i]-128)/128; sum+=v*v; }
    const rms=Math.sqrt(sum/td.length); const dB=linearToDb(rms);
    const thr=parseFloat(gateTh.value), rel=parseFloat(gateRel.value);
    if(isOn(gateBtn)){
      const t=ctx.currentTime;
      if(dB<thr) gateGain.gain.setTargetAtTime(0,t,rel);
      else gateGain.gain.setTargetAtTime(1,t,0.01);
    }else{ gateGain.gain.setTargetAtTime(1,ctx.currentTime,0.01); }
    requestAnimationFrame(loop);
  };
  requestAnimationFrame(loop);
}
function calcLevel(td, mode){
  if(mode==='peak'){ let pk=0; for(let i=0;i<td.length;i++){ const s=Math.abs((td[i]-128)/128); if(s>pk) pk=s; } return Math.min(1, pk/0.7); }
  let sum=0; for(let i=0;i<td.length;i++){ const v=(td[i]-128)/128; sum+=v*v; }
  return Math.min(1, Math.sqrt(sum/td.length)/0.7);
}
function peakFromTD(td){ let pk=0; for(let i=0;i<td.length;i++){ const s=Math.abs((td[i]-128)/128); if(s>pk) pk=s; } return pk; }
function drawLEDBar(ctx2, canvasEl, norm, leds=28){
  const w=canvasEl.clientWidth, h=canvasEl.clientHeight;
  ctx2.clearRect(0,0,w,h);
  const pad=6, gap=2, usable=w-pad*2, ledW=(usable-gap*(leds-1))/leds, ledH=Math.max(8,h-6), y=(h-ledH)/2;
  const active = Math.round(Math.max(0,Math.min(1,norm))*leds);
  for(let i=0;i<leds;i++){
    const x=pad+i*(ledW+gap); const pct=i/(leds-1);
    let col='#22c55e'; if(pct>0.70&&pct<=0.9) col='#eab308'; if(pct>0.9) col='#ef4444';
    ctx2.fillStyle = i<active ? col : 'rgba(148,163,184,0.18)';
    roundRect(ctx2,x,y,ledW,ledH,3,true);
    if(i<active){ ctx2.fillStyle='rgba(255,255,255,0.18)'; roundRect(ctx2,x+1,y+1,Math.max(1,ledW-2),Math.max(2,ledH*0.35),2,true); }
  }
}
function roundRect(ctx2,x,y,w,h,r,fill){ ctx2.beginPath(); ctx2.moveTo(x+r,y); ctx2.arcTo(x+w,y,x+w,y+h,r); ctx2.arcTo(x+w,y+h,x,y+h,r); ctx2.arcTo(x,y+h,x,y,r); ctx2.arcTo(x,y,x+w,y,r); if(fill) ctx2.fill(); else ctx2.stroke(); }
function clearCanvases(){ [vuCanvas,inCanvas,outCanvas].forEach(c=>{ const g=c.getContext('2d'); g.clearRect(0,0,c.clientWidth,c.clientHeight); }); }

/* ===== Size ===== */
function sizeCanvas(el){ const dpr=Math.max(1, Math.floor(window.devicePixelRatio||1)); const r=el.getBoundingClientRect(); el.width=Math.floor(r.width*dpr); el.height=Math.floor(r.height*dpr); el.getContext('2d').setTransform(dpr,0,0,dpr,0,0); }
function sizeAllCanvases(){ [vuCanvas,inCanvas,outCanvas].forEach(sizeCanvas); drawLEDBar(vuCanvas.getContext('2d'), vuCanvas, 0); drawLEDBar(inCanvas.getContext('2d'), inCanvas, 0, 18); drawLEDBar(outCanvas.getContext('2d'), outCanvas, 0, 18); }
window.addEventListener('resize', sizeAllCanvases);
window.addEventListener('orientationchange', sizeAllCanvases);
window.addEventListener('load', sizeAllCanvases);

/* ===== UI Wiring ===== */
// General
$('vu-mode').addEventListener('click', ()=>{ vuMode=(vuMode==='rms'?'peak':'rms'); $('vu-mode').textContent=vuMode.toUpperCase(); });

// Trim + autocal
trimSl.addEventListener('input', ()=>{ trimVal.textContent=trimSl.value; if(inputTrim) inputTrim.gain.value=dBToLinear(parseFloat(trimSl.value)); });
btnCal.addEventListener('click', ()=>{
  if(!ctx){ toast('Start Audio first.'); return;}
  const td=new Uint8Array(preAnalyser.fftSize); let acc=0, n=0; const start=performance.now();
  (function step(){
    preAnalyser.getByteTimeDomainData(td); let s=0; for(let i=0;i<td.length;i++){ const v=(td[i]-128)/128; s+=v*v; } const rms=Math.sqrt(s/td.length); acc+=rms; n++;
    if(performance.now()-start<1000) requestAnimationFrame(step);
    else{ const avg=acc/Math.max(1,n), target= Math.pow(10, (-18)/20); let need=20*Math.log10(target/Math.max(avg,1e-6)); need=Math.max(-18, Math.min(24, need + parseFloat(trimSl.value))); trimSl.value=need.toFixed(1); trimVal.textContent=trimSl.value; if(inputTrim) inputTrim.gain.value=dBToLinear(parseFloat(trimSl.value)); }
  })();
});

// Gate
gateBtn.addEventListener('click', ()=> setToggle(gateBtn, !isOn(gateBtn)));
function syncGate(){ gateThVal.textContent=gateTh.value; gateRelVal.textContent=parseFloat(gateRel.value).toFixed(2); }
gateTh.addEventListener('input', syncGate); gateRel.addEventListener('input', syncGate);
$('gate-quick').addEventListener('click', ()=> setToggle(gateBtn, !isOn(gateBtn)));

// Wah
function syncWah(){ wahFreqVal.textContent=wahFreq.value; wahQVal.textContent=parseFloat(wahQ.value).toFixed(1); if(wah){ wah.frequency.value=parseFloat(wahFreq.value); wah.Q.value=parseFloat(wahQ.value); } wahGain.gain.value = isOn(wahBtn)?1:0; }
wahBtn.addEventListener('click', ()=>{ setToggle(wahBtn, !isOn(wahBtn)); syncWah(); });
wahFreq.addEventListener('input', syncWah); wahQ.addEventListener('input', syncWah);

// Comp
function syncCmp(){ cmpThVal.textContent=cmpTh.value; cmpRaVal.textContent=parseFloat(cmpRa.value).toFixed(1); if(cmp){ cmp.threshold.value=parseFloat(cmpTh.value); cmp.ratio.value=parseFloat(cmpRa.value);} cmp.channelCountMode='explicit'; }
cmpBtn.addEventListener('click', ()=> setToggle(cmpBtn, !isOn(cmpBtn)));
[cmpTh,cmpRa].forEach(el=>el.addEventListener('input', syncCmp));

// Drives
function syncOD(){ odGainVal.textContent=odGain.value; odToneVal.textContent=odToneSl.value; odMixVal.textContent=parseFloat(odMix.value).toFixed(2); if(odShaper) odShaper.curve=makeShaper(parseInt(odGain.value,10),'soft'); if(odTone) odTone.gain.value=parseFloat(odToneSl.value); if(odWet&&odDry){ odWet.gain.value=isOn(odBtn)?parseFloat(odMix.value):0; odDry.gain.value=1-parseFloat(odMix.value);} }
function syncDist(){ distGainVal.textContent=distGain.value; distToneVal.textContent=distToneSl.value; distMixVal.textContent=parseFloat(distMix.value).toFixed(2); if(distShaper) distShaper.curve=makeShaper(parseInt(distGain.value,10),'hard'); if(distTone) distTone.gain.value=parseFloat(distToneSl.value); if(distWet&&distDry){ distWet.gain.value=isOn(distBtn)?parseFloat(distMix.value):0; distDry.gain.value=1-parseFloat(distMix.value);} }
function syncFuzz(){ fuzzGainVal.textContent=fuzzGain.value; fuzzToneVal.textContent=fuzzToneSl.value; fuzzMixVal.textContent=parseFloat(fuzzMix.value).toFixed(2); if(fuzzShaper) fuzzShaper.curve=makeShaper(parseInt(fuzzGain.value,10),'fuzz'); if(fuzzTone) fuzzTone.gain.value=parseFloat(fuzzToneSl.value); if(fuzzWet&&fuzzDry){ fuzzWet.gain.value=isOn(fuzzBtn)?parseFloat(fuzzMix.value):0; fuzzDry.gain.value=1-parseFloat(fuzzMix.value);} }
odBtn.addEventListener('click', ()=>{ setToggle(odBtn, !isOn(odBtn)); syncOD(); });
distBtn.addEventListener('click', ()=>{ setToggle(distBtn, !isOn(distBtn)); syncDist(); });
fuzzBtn.addEventListener('click', ()=>{ setToggle(fuzzBtn, !isOn(fuzzBtn)); syncFuzz(); });
[odGain,odToneSl,odMix].forEach(el=>el.addEventListener('input', syncOD));
[distGain,distToneSl,distMix].forEach(el=>el.addEventListener('input', syncDist));
[fuzzGain,fuzzToneSl,fuzzMix].forEach(el=>el.addEventListener('input', syncFuzz));

// Amp
function syncAmpCurve(){ const m=ampModel.value; ampPre.curve = makeAmpCurve(m, parseInt(ampGain.value,10)); }
function syncAmpUI(){
  ampGainVal.textContent=ampGain.value; ampBassVal.textContent=ampBass.value; ampMidVal.textContent=ampMid.value; ampTrebleVal.textContent=ampTreble.value; ampPresVal.textContent=ampPres.value; ampMasterVal.textContent=parseFloat(ampMasterSl.value).toFixed(2);
  if(ampEQBass) ampEQBass.gain.value=parseFloat(ampBass.value);
  if(ampEQMid)  ampEQMid.gain.value=parseFloat(ampMid.value);
  if(ampEQTreble) ampEQTreble.gain.value=parseFloat(ampTreble.value);
  if(ampPresence) ampPresence.gain.value=parseFloat(ampPres.value);
  if(ampMaster) ampMaster.gain.value=parseFloat(ampMasterSl.value);
  syncAmpCurve();
}
[ampModel,ampGain,ampBass,ampMid,ampTreble,ampPres,ampMasterSl].forEach(el=>el.addEventListener('input', syncAmpUI));

// Cab
function syncCab(){
  const type=cabType.value;
  const lpf = parseFloat(cabLPFSl.value);
  cabHPF.frequency.value = type==='1x12'? 80 : type==='2x12'? 70 : 60;
  cabLPF.frequency.value = lpf;
  cabPeaker.gain.value = type==='4x12'? -4 : type==='2x12'? -3 : -2;
  // enable/disable
  const on = isOn(cabBtn);
  cabHPF.gain && (cabHPF.gain.value=1); // (noop)
  // Nothing to bypass here, just keep enabled; we gate by LPF to 22050 if off
  if(!on){ cabLPF.frequency.value=22050; cabHPF.frequency.value=20; cabPeaker.gain.value=0; }
}
cabBtn.addEventListener('click', ()=>{ setToggle(cabBtn, !isOn(cabBtn)); syncCab(); });
[cabType,cabLPFSl].forEach(el=>el.addEventListener('input', syncCab));

// Chorus
function syncChorus(){
  chorRateVal.textContent=parseFloat(chorRate.value).toFixed(2);
  chorDepthVal.textContent=parseFloat(chorDepth.value).toFixed(2);
  chorMixVal.textContent=parseFloat(chorMix.value).toFixed(2);
  if(chorusLFO) chorusLFO.frequency.value=parseFloat(chorRate.value);
  if(chorusDepthGain) chorusDepthGain.gain.value=parseFloat(chorDepth.value)*0.012;
  if(chorusWet&&chorusDry){ chorusWet.gain.value=isOn(chorBtn)?parseFloat(chorMix.value):0; chorusDry.gain.value=1-parseFloat(chorMix.value); }
}
chorBtn.addEventListener('click', ()=>{ setToggle(chorBtn, !isOn(chorBtn)); syncChorus(); });
[chorRate,chorDepth,chorMix].forEach(el=>el.addEventListener('input', syncChorus));

// Phaser
function syncPhaser(){
  phsRateVal.textContent=parseFloat(phsRate.value).toFixed(2);
  phsDepthVal.textContent=parseFloat(phsDepth.value).toFixed(2);
  phsMixVal.textContent=parseFloat(phsMix.value).toFixed(2);
  if(phaserLFO) phaserLFO.frequency.value=parseFloat(phsRate.value);
  if(phaserDepthGain) phaserDepthGain.gain.value=parseFloat(phsDepth.value)*500;
  if(phaserWet&&phaserDry){ phaserWet.gain.value=isOn(phsBtn)?parseFloat(phsMix.value):0; phaserDry.gain.value=1-parseFloat(phsMix.value); }
}
phsBtn.addEventListener('click', ()=>{ setToggle(phsBtn, !isOn(phsBtn)); syncPhaser(); });
[phsRate,phsDepth,phsMix].forEach(el=>el.addEventListener('input', syncPhaser));

// Trem
function syncTrem(){
  trmRateVal.textContent=parseFloat(trmRate.value).toFixed(1);
  trmDepthVal.textContent=parseFloat(trmDepth.value).toFixed(2);
  trmMixVal.textContent=parseFloat(trmMix.value).toFixed(2);
  if(tremLFO) tremLFO.frequency.value=parseFloat(trmRate.value);
  if(tremWet&&tremDry){ tremWet.gain.value=isOn(trmBtn)?parseFloat(trmMix.value):0; tremDry.gain.value=1-parseFloat(trmMix.value); }
}
trmBtn.addEventListener('click', ()=>{ setToggle(trmBtn, !isOn(trmBtn)); syncTrem(); });
[trmRate,trmDepth,trmMix].forEach(el=>el.addEventListener('input', syncTrem));

// Delay
function syncDelay(){
  dlyTimeVal.textContent=parseFloat(dlyTime.value).toFixed(2);
  dlyFBVal.textContent=parseFloat(dlyFBSl.value).toFixed(2);
  dlyMixVal.textContent=parseFloat(dlyMix.value).toFixed(2);
  if(delay){ delay.delayTime.value=parseFloat(dlyTime.value); }
  if(delayFB){ delayFB.gain.value=parseFloat(dlyFBSl.value); }
  if(delayWet&&delayDry){ delayWet.gain.value=isOn(dlyBtn)?parseFloat(dlyMix.value):0; delayDry.gain.value=1-parseFloat(dlyMix.value); }
}
dlyBtn.addEventListener('click', ()=>{ setToggle(dlyBtn, !isOn(dlyBtn)); syncDelay(); });
[dlyTime,dlyFBSl,dlyMix].forEach(el=>el.addEventListener('input', syncDelay));

// Reverb
function setReverbMix(mix,on){ if(!rvbWet||!rvbDry) return; if(!on){ rvbWet.gain.value=0; rvbDry.gain.value=1; } else { rvbWet.gain.value=mix; rvbDry.gain.value=1-mix; } }
function syncReverb(){
  rvbMixVal.textContent=parseFloat(rvbMix.value).toFixed(2);
  rvbLenVal.textContent=parseFloat(rvbLen.value).toFixed(1);
  reverb.buffer = makeIR(parseFloat(rvbLen.value));
  setReverbMix(parseFloat(rvbMix.value), isOn(rvbBtn));
}
rvbBtn.addEventListener('click', ()=>{ setToggle(rvbBtn, !isOn(rvbBtn)); syncReverb(); });
[rvbMix,rvbLen].forEach(el=>el.addEventListener('input', syncReverb));

// Output
outLevel.addEventListener('input', ()=>{ outLevelVal.textContent=parseFloat(outLevel.value).toFixed(2); if(outGain) outGain.gain.value=parseFloat(outLevel.value); });

/* ===== Presets ===== */
const BUILTINS = {
  'Clean JC':     { dev:'', trim:0, gate:true, gTh:-70, gRel:0.18, wah:false,wF:900,wQ:1.2, cmp:true,cTh:-26,cRa:3,
                    amp:'jazz', aGain:10, aBass:0, aMid:-2, aTre:2, aPres:2, aMaster:1.0,
                    cab:true,cab:'2x12', lpf:6500,
                    od:false,odG:10,odT:2,odM:0.6,
                    dist:false,diG:20,diT:0,diM:0.5,
                    fuzz:false,fzG:30,fzT:-2,fzM:0.4,
                    chor:true,chR:1.2,chD:0.3,chM:0.2,
                    phs:false,phR:0.6,phD:0.6,phM:0.2,
                    trm:false,trR:4.0,trD:0.6,trM:0.8,
                    dly:false,dT:0.32,dF:0.30,dM:0.18,
                    rvb:true,rM:0.16,rL:1.8,
                    out:1.0 },
  'Edge AC30':    { dev:'', trim:0, gate:true, gTh:-65, gRel:0.16, wah:false,wF:1200,wQ:1.4, cmp:true,cTh:-24,cRa:3.2,
                    amp:'ac30', aGain:28, aBass:-2, aMid:1, aTre:3, aPres:3, aMaster:1.0,
                    cab:true,cab:'2x12', lpf:6500,
                    od:true, odG:22, odT:2, odM:1,
                    dist:false,diG:0, diT:0, diM:0.5,
                    fuzz:false,fzG:0, fzT:0, fzM:0.4,
                    chor:false,chR:1.1,chD:0.25,chM:0.18,
                    phs:false,phR:0.6,phD:0.6,phM:0.2,
                    trm:false,trR:5.0,trD:0.5,trM:0.5,
                    dly:true, dT:0.38,dF:0.35,dM:0.22,
                    rvb:true, rM:0.18,rL:2.2,
                    out:1.0 },
  'Crunch Plexi': { dev:'', trim:0, gate:true, gTh:-60, gRel:0.16, wah:false,wF:1000,wQ:1.2, cmp:false,cTh:-22,cRa:3,
                    amp:'plexi', aGain:40, aBass:1, aMid:2, aTre:2, aPres:2, aMaster:1.0,
                    cab:true,cab:'4x12', lpf:5500,
                    od:false,odG:15,odT:2,odM:0.8,
                    dist:true,diG:35,diT:0,diM:1,
                    fuzz:false,fzG:0,fzT:0,fzM:0.4,
                    chor:false,chR:1.0,chD:0.25,chM:0.15,
                    phs:true, phR:0.7,phD:0.7,phM:0.25,
                    trm:false,trR:4.0,trD:0.6,trM:0.6,
                    dly:false,dT:0.30,dF:0.25,dM:0.18,
                    rvb:true, rM:0.12,rL:1.6,
                    out:1.0 },
  'Texas Tweed':  { dev:'', trim:0, gate:true, gTh:-60, gRel:0.20, wah:false,wF:900,wQ:1.3, cmp:true,cTh:-22,cRa:2.8,
                    amp:'tweed', aGain:35, aBass:2, aMid:-1, aTre:1, aPres:1, aMaster:1.0,
                    cab:true,cab:'1x12', lpf:6000,
                    od:true, odG:25,odT:3,odM:1,
                    dist:false,diG:0, diT:0, diM:0.5,
                    fuzz:false,fzG:0,fzT:0,fzM:0.5,
                    chor:false,chR:1.2,chD:0.25,chM:0.15,
                    phs:false,phR:0.6,phD:0.6,phM:0.2,
                    trm:true, trR:4.8,trD:0.6,trM:0.8,
                    dly:false,dT:0.11,dF:0.18,dM:0.12,
                    rvb:true, rM:0.14,rL:1.8,
                    out:1.0 },
  'Modern Metal': { dev:'', trim:0, gate:true, gTh:-55, gRel:0.12, wah:false,wF:900,wQ:1.2, cmp:false,cTh:-20,cRa:3.5,
                    amp:'modern', aGain:75, aBass:4, aMid:-4, aTre:4, aPres:4, aMaster:0.95,
                    cab:true,cab:'4x12', lpf:5000,
                    od:true, odG:18,odT:4,odM:0.7,
                    dist:true,diG:55,diT:2,diM:1,
                    fuzz:false,fzG:0,fzT:0,fzM:0.4,
                    chor:false,chR:1.0,chD:0.2,chM:0.1,
                    phs:false,phR:0.6,phD:0.6,phM:0.2,
                    trm:false,trR:4.0,trD:0.7,trM:0.6,
                    dly:false,dT:0.28,dF:0.25,dM:0.14,
                    rvb:true, rM:0.10,rL:1.4,
                    out:1.0 },
  'Ambient Wash': { dev:'', trim:0, gate:false,gTh:-70, gRel:0.18, wah:false,wF:900,wQ:1.2, cmp:true,cTh:-28,cRa:2.5,
                    amp:'blackface', aGain:18,aBass:0,aMid:-2,aTre:2,aPres:2,aMaster:1.0,
                    cab:true,cab:'2x12', lpf:7000,
                    od:false,odG:10,odT:2,odM:0.5,
                    dist:false,diG:0, diT:0, diM:0.5,
                    fuzz:false,fzG:0, fzT:0, fzM:0.5,
                    chor:true, chR:0.8,chD:0.5,chM:0.35,
                    phs:false, phR:0.4,phD:0.5,phM:0.2,
                    trm:false, trR:3.2,trD:0.5,trM:0.6,
                    dly:true, dT:0.55,dF:0.45,dM:0.35,
                    rvb:true, rM:0.30,rL:3.0,
                    out:1.0 },
  'Funk Wah':     { dev:'', trim:0, gate:true, gTh:-65, gRel:0.18, wah:true,wF:1400,wQ:3.0, cmp:true,cTh:-24,cRa:3.2,
                    amp:'jazz', aGain:12,aBass:-1,aMid:-1,aTre:2,aPres:2,aMaster:1.0,
                    cab:true,cab:'2x12', lpf:7000,
                    od:false,odG:12,odT:2,odM:0.6,
                    dist:false,diG:0, diT:0, diM:0.4,
                    fuzz:false,fzG:0, fzT:0, fzM:0.4,
                    chor:false,chR:1.5,chD:0.25,chM:0.15,
                    phs:true, phR:0.8,phD:0.7,phM:0.2,
                    trm:false, trR:5.5,trD:0.6,trM:0.8,
                    dly:false,dT:0.18,dF:0.20,dM:0.14,
                    rvb:true, rM:0.10,rL:1.2,
                    out:1.0 },
};
presetApply.addEventListener('click', ()=>{ const n=presetSel.value; if(!n||!BUILTINS[n]) return; applyPreset(BUILTINS[n]); });

function applyPreset(p){
  // gate & trim
  trimSl.value=p.trim; trimVal.textContent=p.trim; if(inputTrim) inputTrim.gain.value=dBToLinear(p.trim);
  setToggle(gateBtn, !!p.gate); gateTh.value=p.gTh; gateRel.value=p.gRel; gateThVal.textContent=p.gTh; gateRelVal.textContent=p.gRel.toFixed(2);

  setToggle(wahBtn, !!p.wah); wahFreq.value=p.wF; wahQ.value=p.wQ; syncWah();

  setToggle(cmpBtn, !!p.cmp); cmpTh.value=p.cTh; cmpRa.value=p.cRa; syncCmp();

  ampModel.value=p.amp; ampGain.value=p.aGain; ampBass.value=p.aBass; ampMid.value=p.aMid; ampTreble.value=p.aTre; ampPres.value=p.aPres; ampMasterSl.value=p.aMaster; syncAmpUI();

  setToggle(cabBtn, !!p.cab); cabType.value=p.cab; cabLPFSl.value=p.lpf; syncCab();

  setToggle(odBtn, !!p.od); odGain.value=p.odG; odToneSl.value=p.odT; odMix.value=p.odM; syncOD();
  setToggle(distBtn, !!p.dist); distGain.value=p.diG; distToneSl.value=p.diT; distMix.value=p.diM; syncDist();
  setToggle(fuzzBtn, !!p.fuzz); fuzzGain.value=p.fzG; fuzzToneSl.value=p.fzT; fuzzMix.value=p.fzM; syncFuzz();

  setToggle(chorBtn, !!p.chor); chorRate.value=p.chR; chorDepth.value=p.chD; chorMix.value=p.chM; syncChorus();
  setToggle(phsBtn, !!p.phs); phsRate.value=p.phR; phsDepth.value=p.phD; phsMix.value=p.phM; syncPhaser();
  setToggle(trmBtn, !!p.trm); trmRate.value=p.trR; trmDepth.value=p.trD; trmMix.value=p.trM; syncTrem();

  setToggle(dlyBtn, !!p.dly); dlyTime.value=p.dT; dlyFBSl.value=p.dF; dlyMix.value=p.dM; syncDelay();

  setToggle(rvbBtn, !!p.rvb); rvbMix.value=p.rM; rvbLen.value=p.rL; syncReverb();

  outLevel.value=p.out; outLevelVal.textContent=p.out.toFixed(2); if(outGain) outGain.gain.value=p.out;
}

/* ===== User Slots: 10 named + export/import ===== */
const SLOTS_KEY='gtrRigUserSlotsV1';
function initSlots(){
  let s=JSON.parse(localStorage.getItem(SLOTS_KEY)||'null');
  if(!Array.isArray(s)||s.length!==10){ s=Array.from({length:10},(_,i)=>({name:`Slot ${i+1}`, data:null})); localStorage.setItem(SLOTS_KEY, JSON.stringify(s)); }
  return s;
}
function saveSlots(slots){ localStorage.setItem(SLOTS_KEY, JSON.stringify(slots)); }
function snapshot(){
  return {
    trim:parseFloat(trimSl.value), gate:isOn(gateBtn), gTh:parseFloat(gateTh.value), gRel:parseFloat(gateRel.value),
    wah:isOn(wahBtn), wF:parseFloat(wahFreq.value), wQ:parseFloat(wahQ.value),
    cmp:isOn(cmpBtn), cTh:parseFloat(cmpTh.value), cRa:parseFloat(cmpRa.value),
    amp:ampModel.value, aGain:parseInt(ampGain.value,10), aBass:parseFloat(ampBass.value), aMid:parseFloat(ampMid.value), aTre:parseFloat(ampTreble.value), aPres:parseFloat(ampPres.value), aMaster:parseFloat(ampMasterSl.value),
    cab:isOn(cabBtn), cab:cabType.value, lpf:parseFloat(cabLPFSl.value),
    od:isOn(odBtn), odG:parseInt(odGain.value,10), odT:parseFloat(odToneSl.value), odM:parseFloat(odMix.value),
    dist:isOn(distBtn), diG:parseInt(distGain.value,10), diT:parseFloat(distToneSl.value), diM:parseFloat(distMix.value),
    fuzz:isOn(fuzzBtn), fzG:parseInt(fuzzGain.value,10), fzT:parseFloat(fuzzToneSl.value), fzM:parseFloat(fuzzMix.value),
    chor:isOn(chorBtn), chR:parseFloat(chorRate.value), chD:parseFloat(chorDepth.value), chM:parseFloat(chorMix.value),
    phs:isOn(phsBtn), phR:parseFloat(phsRate.value), phD:parseFloat(phsDepth.value), phM:parseFloat(phsMix.value),
    trm:isOn(trmBtn), trR:parseFloat(trmRate.value), trD:parseFloat(trmDepth.value), trM:parseFloat(trmMix.value),
    dly:isOn(dlyBtn), dT:parseFloat(dlyTime.value), dF:parseFloat(dlyFBSl.value), dM:parseFloat(dlyMix.value),
    rvb:isOn(rvbBtn), rM:parseFloat(rvbMix.value), rL:parseFloat(rvbLen.value),
    out:parseFloat(outLevel.value)
  };
}
function initUserSlotsUI(){
  const s=initSlots();
  slotSel.innerHTML='';
  s.forEach((sl,i)=>{ const o=document.createElement('option'); o.value=String(i); o.textContent=`${i+1}. ${sl.name}${sl.data?'':' (empty)'}`; slotSel.appendChild(o); });
  slotGrid.innerHTML='';
  s.forEach((sl,i)=>{ const b=document.createElement('button'); b.className='slotbtn'; b.textContent=`${i+1}. ${sl.name.slice(0,14)}`; b.title=sl.name; b.addEventListener('click',()=>{ const slots=initSlots(); const slot=slots[i]; if(!slot.data){ toast('That slot is empty.'); return; } applyPreset(slot.data); toast(`Loaded: ${slot.name}`); }); slotGrid.appendChild(b); });
}
slotLoad.addEventListener('click', ()=>{ const idx=parseInt(slotSel.value,10); if(isNaN(idx)) return; const s=initSlots(); const sl=s[idx]; if(!sl.data){ toast('That slot is empty.'); return; } applyPreset(sl.data); toast(`Loaded: ${sl.name}`); });
slotSave.addEventListener('click', ()=>{ const idx=parseInt(slotSel.value,10); if(isNaN(idx)) return; const s=initSlots(); const name=s[idx].name||`Slot ${idx+1}`; s[idx]={name, data:snapshot()}; saveSlots(s); initUserSlotsUI(); slotSel.value=String(idx); toast(`Saved: ${name}`); });
slotRename.addEventListener('click', ()=>{ const idx=parseInt(slotSel.value,10); if(isNaN(idx)) return; const s=initSlots(); const current=s[idx].name||`Slot ${idx+1}`; const nn=prompt('Name this preset slot:', current); if(!nn) return; s[idx].name = nn.trim().slice(0,32); saveSlots(s); initUserSlotsUI(); slotSel.value=String(idx); toast(`Renamed to: ${s[idx].name}`); });
slotExport.addEventListener('click', ()=>{ const payload={version:1, slots:initSlots()}; const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='guitar_rig_presets.json'; a.click(); URL.revokeObjectURL(url); });
slotImport.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', ()=>{ const f=importFile.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(!obj||!Array.isArray(obj.slots)||obj.slots.length!==10) throw Error('Invalid'); localStorage.setItem(SLOTS_KEY, JSON.stringify(obj.slots)); initUserSlotsUI(); toast('Imported presets.'); }catch(e){ toast('Import failed.'); } }; r.readAsText(f); });

</script>
</body>
</html>
